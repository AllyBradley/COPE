

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>wp4.compare.models.donor &mdash; COPE DB 0.8.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../search.html"/>
    <link rel="top" title="COPE DB 0.8.2 documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> COPE DB
          

          
          </a>

          
            
            
              <div class="version">
                0.8.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/user_manual.html">COPE DB User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/development.html">Development Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/design/wp4_design.html">Design - WP4:Compare</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/design/wp7_design.html">Design - WP7:Biobanking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/models.html">Data Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../source/changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">COPE DB</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>wp4.compare.models.donor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for wp4.compare.models.donor</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># coding: utf-8</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">bdateutil</span> <span class="k">import</span> <span class="n">relativedelta</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ObjectDoesNotExist</span>
<span class="kn">from</span> <span class="nn">django.core.validators</span> <span class="k">import</span> <span class="n">MinValueValidator</span><span class="p">,</span> <span class="n">MaxValueValidator</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">transaction</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="k">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.utils.functional</span> <span class="k">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="k">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">from</span> <span class="nn">wp4.perfusion_machine.models</span> <span class="k">import</span> <span class="n">Machine</span>
<span class="kn">from</span> <span class="nn">wp4.staff.models</span> <span class="k">import</span> <span class="n">Person</span>
<span class="kn">from</span> <span class="nn">..validators</span> <span class="k">import</span> <span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span>
<span class="kn">from</span> <span class="nn">..managers.core</span> <span class="k">import</span> <span class="n">DonorModelForUserManager</span>
<span class="kn">from</span> <span class="nn">..managers.core</span> <span class="k">import</span> <span class="n">ClosedOrganModelForUserManager</span><span class="p">,</span> <span class="n">AllocatableModelForUserManager</span><span class="p">,</span> <span class="n">OpenOrganModelForUserManager</span>
<span class="kn">from</span> <span class="nn">..managers.core</span> <span class="k">import</span> <span class="n">OrganModelForUserManager</span><span class="p">,</span> <span class="n">ProcurementResourceModelForUserManager</span>
<span class="kn">from</span> <span class="nn">.core</span> <span class="k">import</span> <span class="n">Patient</span><span class="p">,</span> <span class="n">Randomisation</span><span class="p">,</span> <span class="n">RetrievalTeam</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">YES_NO_UNKNOWN_CHOICES</span><span class="p">,</span> <span class="n">PRESERVATION_HMP</span><span class="p">,</span> <span class="n">PRESERVATION_HMPO2</span><span class="p">,</span> <span class="n">PRESERVATION_NOT_SET</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">LOCATION_CHOICES</span><span class="p">,</span> <span class="n">PRESERVATION_CHOICES</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">LEFT</span><span class="p">,</span> <span class="n">RIGHT</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">AuditControlModelBase</span>


<div class="viewcode-block" id="Donor"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Donor">[docs]</a><span class="k">class</span> <span class="nc">Donor</span><span class="p">(</span><span class="n">AuditControlModelBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extension of an Patient record (via OneToOne link for good ORM/DB management) to capture</span>
<span class="sd">    the Donor specific data</span>

<span class="sd">    Also holds the meta-data specific to the Procurement Form</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">Patient</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal link to Patient&quot;</span><span class="p">)</span>
    <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MaxValueValidator</span><span class="p">(</span><span class="mi">99</span><span class="p">)],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal value for tracking trial ID sequence number. Value of 1-99&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Donor Form metadata</span>
    <span class="n">NON_RANDOMISATION_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc15 Not Applicable&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc10 Donor not proceeding&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc11 One or more kidneys allocated to non-trial location&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc12 Kidneys not allocated&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc13 Kidneys not transplanable&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc14 Other&quot;</span><span class="p">)),</span>
    <span class="p">)</span>  <span class="c1">#: Donor not_randomised_because choices</span>
    <span class="n">multiple_recipients</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO02 Multiple recipients&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">YES_NO_UNKNOWN_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to YES_NO_UNKNOWN_CHOICES</span>
    <span class="n">not_randomised_because</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DO51 Why was this not randomised?&quot;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">NON_RANDOMISATION_CHOICES</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">not_randomised_because_other</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO52 More details&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">procurement_form_completed</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DO99 Form complete&quot;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Select Yes when you believe the form is complete and you have no more data to enter&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">admin_notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DO50 Admin notes&quot;</span><span class="p">),</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">trial_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO99 donor id&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Procedure data</span>
    <span class="n">retrieval_team</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">RetrievalTeam</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DO01 retrieval team&quot;</span><span class="p">))</span>
    <span class="n">perfusion_technician</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">Person</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO03 name of transplant technician&#39;</span><span class="p">),</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;donor_perfusion_technician_set&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">transplant_coordinator</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">Person</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO04 name of the SN-OD&#39;</span><span class="p">),</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;donor_transplant_coordinator_set&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">call_received</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO05 Consultant to MTO called at&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">call_received_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="c1"># retrieval_hospital changed to charfield from foreignkey as per issue #211</span>
    <span class="n">retrieval_hospital</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO06 donor hospital&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">scheduled_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO07 time of withdrawal therapy&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050&quot;</span>
    <span class="p">)</span>
    <span class="n">scheduled_start_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">technician_arrival</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO08 arrival time of technician&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">technician_arrival_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">ice_boxes_filled</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO09 ice boxes filled&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">ice_boxes_filled_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">depart_perfusion_centre</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO10 departure from base hospital at&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">depart_perfusion_centre_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">arrival_at_donor_hospital</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO11 arrival at donor hospital&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">arrival_at_donor_hospital_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>

    <span class="c1"># Donor details (in addition to Patient)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO12 age&#39;</span><span class="p">),</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">MaxValueValidator</span><span class="p">(</span><span class="mi">99</span><span class="p">)],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Age must be in the range 50-99&quot;</span>
    <span class="p">)</span>
    <span class="n">date_of_admission</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO13 date of admission&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">date_of_admission_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">admitted_to_itu</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO14 admitted to ITU&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">date_admitted_to_itu</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO15 when admitted to ITU&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">date_admitted_to_itu_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">date_of_procurement</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO16 date of procurement&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">other_organs_procured</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DO17 other organs procured&quot;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">other_organs_lungs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DO18 lungs&quot;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">other_organs_pancreas</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DO19 pancreas&quot;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">other_organs_liver</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DO20 liver&quot;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">other_organs_tissue</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DO21 tissue&quot;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># DonorPreop data</span>
    <span class="n">DIAGNOSIS_CEREBROVASCULAR_ACCIDENT</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#: Constant for DIAGNOSIS_CHOICES</span>
    <span class="n">DIAGNOSIS_HYPOXIA</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1">#: Constant for DIAGNOSIS_CHOICES</span>
    <span class="n">DIAGNOSIS_TRAUMA</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1">#: Constant for DIAGNOSIS_CHOICES</span>
    <span class="n">DIAGNOSIS_OTHER</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1">#: Constant for DIAGNOSIS_CHOICES</span>
    <span class="n">DIAGNOSIS_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">DIAGNOSIS_CEREBROVASCULAR_ACCIDENT</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc01 Cerebrovascular Accident&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">DIAGNOSIS_HYPOXIA</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc02 Hypoxia&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">DIAGNOSIS_TRAUMA</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc03 Trauma&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">DIAGNOSIS_OTHER</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc04 Other&quot;</span><span class="p">))</span>
    <span class="p">)</span>  <span class="c1">#: Donor diagnosis choices</span>
    <span class="n">diagnosis</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO22 diagnosis&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">DIAGNOSIS_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">diagnosis_other</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO23 other diagnosis&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">diabetes_melitus</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO24 diabetes mellitus&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">YES_NO_UNKNOWN_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to YES_NO_UNKNOWN_CHOICES</span>
    <span class="n">alcohol_abuse</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO25 alcohol abuse&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">YES_NO_UNKNOWN_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to YES_NO_UNKNOWN_CHOICES</span>
    <span class="n">cardiac_arrest</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO26 cardiac arrest&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Cardiac Arrest (During ITU stay, prior to Retrieval Procedure)</span>
    <span class="n">systolic_blood_pressure</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO27 last systolic blood pressure&#39;</span><span class="p">),</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">MaxValueValidator</span><span class="p">(</span><span class="mi">200</span><span class="p">)],</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Value must be in the range 10-200&quot;</span>
    <span class="p">)</span>  <span class="c1">#: Last Systolic Blood Pressure (Before switch off)</span>
    <span class="n">diastolic_blood_pressure</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO28 last diastolic blood pressure&#39;</span><span class="p">),</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">MaxValueValidator</span><span class="p">(</span><span class="mi">200</span><span class="p">)],</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Value must be in the range 10-200&quot;</span>
    <span class="p">)</span>  <span class="c1">#: Last Diastolic Blood Pressure (Before switch off)</span>
    <span class="n">diuresis_last_day</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO29 diuresis last day (ml)&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">diuresis_last_day_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">diuresis_last_hour</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO30 diuresis last hour (ml)&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">diuresis_last_hour_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">dopamine</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO31 dopamine&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">YES_NO_UNKNOWN_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to YES_NO_UNKNOWN_CHOICES</span>
    <span class="n">dobutamine</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO32 dobutamine&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">YES_NO_UNKNOWN_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to YES_NO_UNKNOWN_CHOICES</span>
    <span class="n">nor_adrenaline</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO33 nor adrenaline&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">YES_NO_UNKNOWN_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to YES_NO_UNKNOWN_CHOICES</span>
    <span class="n">vasopressine</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO34 vasopressine&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">YES_NO_UNKNOWN_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to YES_NO_UNKNOWN_CHOICES</span>
    <span class="n">other_medication_details</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO35 other medication&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Lab results</span>
    <span class="n">UNIT_MGDL</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#: Constant for UNIT_CHOICES</span>
    <span class="n">UNIT_UMOLL</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1">#: Constant for UNIT_CHOICES</span>
    <span class="n">UNIT_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">UNIT_MGDL</span><span class="p">,</span> <span class="s2">&quot;mg/dl&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">UNIT_UMOLL</span><span class="p">,</span> <span class="s2">&quot;umol/L&quot;</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1">#: Donor last_creatinine_unit and max_creatinine_unit choices</span>
    <span class="n">last_creatinine</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO36 last creatinine&#39;</span><span class="p">),</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="p">],</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">last_creatinine_unit</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">UNIT_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">UNIT_MGDL</span><span class="p">)</span>
    <span class="n">max_creatinine</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO37 max creatinine&#39;</span><span class="p">),</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">max_creatinine_unit</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">UNIT_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">UNIT_MGDL</span><span class="p">)</span>

    <span class="c1"># Operation Data - Extraction</span>
    <span class="n">SOLUTION_UW</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#: Constant for SOLUTION_CHOICES</span>
    <span class="n">SOLUTION_MARSHALL</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1">#: Constant for SOLUTION_CHOICES</span>
    <span class="n">SOLUTION_HTK</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1">#: Constant for SOLUTION_CHOICES</span>
    <span class="n">SOLUTION_OTHER</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1">#: Constant for SOLUTION_CHOICES</span>
    <span class="n">SOLUTION_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">SOLUTION_HTK</span><span class="p">,</span> <span class="s2">&quot;HTK&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">SOLUTION_MARSHALL</span><span class="p">,</span> <span class="s2">&quot;Marshall&#39;s&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">SOLUTION_UW</span><span class="p">,</span> <span class="s2">&quot;UW&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">SOLUTION_OTHER</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOc04 Other&quot;</span><span class="p">))</span>
    <span class="p">)</span>  <span class="c1">#: Donor systemic_flush_used choices</span>
    <span class="n">life_support_withdrawal</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO38 withdrawal of life support&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">systolic_pressure_low</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO39 systolic arterial pressure&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>  <span class="c1">#: &lt; 50 mm Hg (inadequate organ perfusion)</span>
    <span class="n">systolic_pressure_low_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">o2_saturation</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO40 O2 saturation below 80%&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">o2_saturation_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">circulatory_arrest</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO41 end of cardiac output&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>  <span class="c1">#: Also known as the start of no touch period</span>
    <span class="n">circulatory_arrest_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">length_of_no_touch</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO42 length of no touch period (minutes)&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">MaxValueValidator</span><span class="p">(</span><span class="mi">60</span><span class="p">)],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Value must be in the range 1-60 minutes&quot;</span>
    <span class="p">)</span>
    <span class="n">death_diagnosed</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO43 knife to skin time&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO43h This also counts as Date of Death for donor. Date must be fall within 1900-2050, and not be in the future&#39;</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1">#: Changes to this require sync to the Patient.date_of_death, see the save method</span>
    <span class="n">perfusion_started</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO44 start in-situ cold perfusion&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">perfusion_started_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">systemic_flush_used</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO45 systemic (aortic) flush solution used&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">SOLUTION_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">systemic_flush_used_other</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO46 systemic flush used&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">systemic_flush_volume_used</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO47 aortic - volume (ml)&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: NB: this doesn&#39;t appear on the paper forms</span>
    <span class="n">heparin</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;DO48 heparin&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: As administered to donor/in flush solution</span>

    <span class="c1"># Internal references back to Organ, to help speed up the linking and querying from the DB</span>
    <span class="n">_left_kidney</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="s1">&#39;Organ&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;left_kidney&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">_right_kidney</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="s1">&#39;Organ&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;right_kidney&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">DonorModelForUserManager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">order_with_respect_to</span> <span class="o">=</span> <span class="s1">&#39;retrieval_team&#39;</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;DOm1 donor&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;DOm2 donors&#39;</span><span class="p">)</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;view_donor&quot;</span><span class="p">,</span> <span class="s2">&quot;Can only view the data&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;restrict_to_national&quot;</span><span class="p">,</span> <span class="s2">&quot;Can only use data from the same location country&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;restrict_to_local&quot;</span><span class="p">,</span> <span class="s2">&quot;Can only use data from a specific location&quot;</span><span class="p">),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Donor.country_for_restriction"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Donor.country_for_restriction">[docs]</a>    <span class="k">def</span> <span class="nf">country_for_restriction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the country to be used for geographic restriction of this data</span>
<span class="sd">        :return: Int: Value from list in Locations.Models. Should be in range [1,4,5]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_team</span><span class="o">.</span><span class="n">based_at</span><span class="o">.</span><span class="n">country</span></div>

<div class="viewcode-block" id="Donor.location_for_restriction"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Donor.location_for_restriction">[docs]</a>    <span class="k">def</span> <span class="nf">location_for_restriction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the location to be used for geographic restriction of this data</span>
<span class="sd">        :return: Int: Hospital object id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_team</span><span class="o">.</span><span class="n">based_at</span><span class="o">.</span><span class="n">id</span></div>

<div class="viewcode-block" id="Donor.clean"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Donor.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the following fields of data if their corresponding unknown flag is set to True</span>

<span class="sd">        * call_received</span>
<span class="sd">        * scheduled_start</span>
<span class="sd">        * technician_arrival</span>
<span class="sd">        * ice_boxes_filled</span>
<span class="sd">        * depart_perfusion_centre</span>
<span class="sd">        * arrival_at_donor_hospital</span>
<span class="sd">        * date_of_admission</span>
<span class="sd">        * date_admitted_to_itu</span>
<span class="sd">        * diuresis_last_day</span>
<span class="sd">        * diuresis_last_hour</span>
<span class="sd">        * systolic_pressure_low</span>
<span class="sd">        * o2_saturation</span>
<span class="sd">        * circulatory_arrest</span>
<span class="sd">        * perfusion_started</span>

<span class="sd">        Error if:</span>

<span class="sd">        * arrival_at_donor_hospital before depart_perfusion_centre (DOv01)</span>
<span class="sd">        * age does not match person.age_from_dob (DOv05)</span>
<span class="sd">        * date_of_birth is less than 50 years before date_of_procurement (DOv03)</span>
<span class="sd">        * date_of_birth is more than 100 years before date_of_procurement (DOv04)</span>
<span class="sd">        * date_of_procurement before date_of_admission (DOv06)</span>
<span class="sd">        * admitted_to_itu without recording date_admitted_to_itu (DOv07)</span>
<span class="sd">        * diagnosis is set to Other, and diagnosis_other is empty (DOv08)</span>
<span class="sd">        * date_admitted_to_itu before date_of_admission (DOv12)</span>
<span class="sd">        * life_support_withdrawal before date_of_admission (DOv09)</span>
<span class="sd">        * circulatory_arrest after death_diagnosed (DOv10) - a pre-requisite for DCD case eligibility</span>
<span class="sd">        * systemic_flush_used is set to Other, but systemic_flush_used_other is empty (DOv11)</span>
<span class="sd">        * procurement_form_completed is True, but: retrieval_hospital is not set (DOv12); and person.number is empty (DOv13)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clean the fields that at Not Known</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_received_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_received</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_start_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">technician_arrival_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">technician_arrival</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_boxes_filled_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ice_boxes_filled</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depart_perfusion_centre_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depart_perfusion_centre</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival_at_donor_hospital_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arrival_at_donor_hospital</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_of_admission_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_of_admission</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_admitted_to_itu_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_admitted_to_itu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diuresis_last_day_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diuresis_last_day</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diuresis_last_hour_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diuresis_last_hour</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">systolic_pressure_low_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">systolic_pressure_low</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">o2_saturation_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">o2_saturation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulatory_arrest_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circulatory_arrest</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfusion_started_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perfusion_started</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival_at_donor_hospital</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">depart_perfusion_centre</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrival_at_donor_hospital</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">depart_perfusion_centre</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="c1"># TODO: Fix the lack of space in the strings when joined</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv01 Time travel detected! Arrival at donor hospital occurred before departure&quot;</span>
                        <span class="s2">&quot;from perfusion centre&quot;</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">person_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">date_of_birth</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">age_from_dob</span><span class="p">:</span>
                <span class="n">the_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">date_of_death</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">date_of_death</span> <span class="k">else</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="n">lower_date</span> <span class="o">=</span> <span class="n">the_end</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">,</span> <span class="n">months</span><span class="o">=-</span><span class="mi">12</span><span class="p">,</span> <span class="n">days</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">upper_date</span> <span class="o">=</span> <span class="n">the_end</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="c1"># TODO: Fix the lack of space in the strings when joined</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv05 Age (</span><span class="si">%(age)d</span><span class="s2">) does not match age as calculated (</span><span class="si">%(num)d</span><span class="s2"> years) from Date of&quot;</span>
                        <span class="s2">&quot;Birth. DoB should be between </span><span class="si">%(date1)s</span><span class="s2"> and </span><span class="si">%(date2)s</span><span class="s2">.&quot;</span>
                        <span class="o">%</span> <span class="p">{</span>
                            <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span><span class="p">,</span>
                            <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">age_from_dob</span><span class="p">,</span>
                            <span class="s1">&#39;date1&#39;</span><span class="p">:</span> <span class="n">lower_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %Y&#39;</span><span class="p">),</span>
                            <span class="s1">&#39;date2&#39;</span><span class="p">:</span> <span class="n">upper_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %Y&#39;</span><span class="p">)</span>
                        <span class="p">})</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_of_procurement</span><span class="p">:</span>
                <span class="n">calculated_age</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">date_of_procurement</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">date_of_birth</span><span class="p">)</span><span class="o">.</span><span class="n">years</span>
                <span class="k">if</span> <span class="n">calculated_age</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv03 Date of birth is less than 50 years from the date of procurement (</span><span class="si">%(num)d</span><span class="s2">)&quot;</span>
                          <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">calculated_age</span><span class="p">})</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">calculated_age</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv04 Date of birth is more than 100 years from the date of procurement (</span><span class="si">%(num)d</span><span class="s2">)&quot;</span>
                          <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">calculated_age</span><span class="p">})</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_of_procurement</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_of_admission</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_of_procurement</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_of_admission</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv06 Date of procurement occurs before date of admission&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">admitted_to_itu</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_admitted_to_itu</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv07 Missing the date admitted to ITU&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnosis</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIAGNOSIS_OTHER</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnosis_other</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv08 Missing the other diagnosis&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_admitted_to_itu</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_of_admission</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_admitted_to_itu</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_of_admission</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv12 Donor in ICU before they were admitted to hospital&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">life_support_withdrawal</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_of_admission</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">life_support_withdrawal</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_of_admission</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv09 Life support withdrawn before admission to hospital&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulatory_arrest</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">death_diagnosed</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circulatory_arrest</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">death_diagnosed</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv10 Donor was diagnosed as dead before circulation stopped&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">systemic_flush_used</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">systemic_flush_used</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SOLUTION_OTHER</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">systemic_flush_used_other</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv11 Missing the details of the other systemic flush solution used&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">procurement_form_completed</span><span class="p">:</span>
            <span class="c1"># This is not a critical piece of information any more</span>
            <span class="c1"># if self.retrieval_hospital is None:</span>
            <span class="c1">#     raise ValidationError(_(&quot;DOv12 Missing retrieval hospital&quot;))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;DOv13 Please enter the NHSBT number&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Donor.save"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Donor.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_insert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updated save method to ensure that if death_diagnosed is set, then this is reflected in the</span>
<span class="sd">        same value for person.date_of_death</span>

<span class="sd">        :param force_insert: bool. As parent method</span>
<span class="sd">        :param force_update: bool. As parent method</span>
<span class="sd">        :param using:  As parent method</span>
<span class="sd">        :param update_fields:  As parent method</span>
<span class="sd">        :return: super(Donor, self).save()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">death_diagnosed</span><span class="p">:</span>
            <span class="c1"># Have to sync this data to the Patient.date_of_death</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">date_of_death</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">death_diagnosed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Donor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">force_insert</span><span class="p">,</span> <span class="n">force_update</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="n">update_fields</span><span class="p">)</span></div>

    <span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<div class="viewcode-block" id="Donor.randomise"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Donor.randomise">[docs]</a>    <span class="k">def</span> <span class="nf">randomise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_online</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">active_user</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Randomise if eligible and not already done. This is determined by looking at the elibility</span>
<span class="sd">        criteria, and checking that the Organ.preservation is not set. Once randomised, the</span>
<span class="sd">        sequence_number is allocated for the Trial ID to be defined. The location of the</span>
<span class="sd">        retrieval_team is used to determine which geographical list set to use, and the is_online</span>
<span class="sd">        value determines which of the two lists to pick from.</span>

<span class="sd">        :param is_online: bool. Pick from an online list if True, or an Offline list if False</span>
<span class="sd">        :param active_user: The user that is triggering the randomisation process</span>
<span class="sd">        :return: True if randomisation occurs, False otherwise</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="n">update_trial_ids_and_save</span>

        <span class="n">left_kidney</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_kidney</span>
        <span class="n">right_kidney</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_kidney</span>
        <span class="k">if</span> <span class="n">left_kidney</span><span class="o">.</span><span class="n">preservation</span> <span class="o">==</span> <span class="n">PRESERVATION_NOT_SET</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_recipients</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> \
                <span class="ow">and</span> <span class="n">left_kidney</span><span class="o">.</span><span class="n">transplantable</span> \
                <span class="ow">and</span> <span class="n">right_kidney</span><span class="o">.</span><span class="n">transplantable</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Randomisation</span><span class="o">.</span><span class="n">get_and_assign_result</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_team</span><span class="o">.</span><span class="n">get_randomisation_list</span><span class="p">(</span><span class="n">is_online</span><span class="p">),</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">active_user</span>
            <span class="p">):</span>
                <span class="n">left_kidney</span><span class="o">.</span><span class="n">preservation</span> <span class="o">=</span> <span class="n">PRESERVATION_HMPO2</span>
                <span class="n">right_kidney</span><span class="o">.</span><span class="n">preservation</span> <span class="o">=</span> <span class="n">PRESERVATION_HMP</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">left_kidney</span><span class="o">.</span><span class="n">preservation</span> <span class="o">=</span> <span class="n">PRESERVATION_HMP</span>
                <span class="n">right_kidney</span><span class="o">.</span><span class="n">preservation</span> <span class="o">=</span> <span class="n">PRESERVATION_HMPO2</span>
            <span class="n">left_kidney</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">right_kidney</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="c1"># On randomise (not save anymore), get and save the sequence number from the retrieval team</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sequence_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_team</span><span class="o">.</span><span class="n">next_sequence_number</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">update_trial_ids_and_save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">left_kidney</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property to emulate a safe get_or_create call to Organ. If no linked organ, a new record is</span>
<span class="sd">        created with sensible defaults and linked.</span>

<span class="sd">        :return: Organ record for the left kidney</span>
<span class="sd">        :rtype: wp4.compare.models.organ.Organ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wp4.compare.models</span> <span class="k">import</span> <span class="n">Organ</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_kidney</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_left_kidney</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">organ_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">location__exact</span><span class="o">=</span><span class="n">LEFT</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># Organ.DoesNotExist:</span>
                <span class="c1"># print(&quot;DEBUG: Donor.left_kidney() raised IndexError&quot;)</span>
                <span class="n">new_organ</span> <span class="o">=</span> <span class="n">Organ</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">LEFT</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">new_organ</span><span class="o">.</span><span class="n">donor</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="n">new_organ</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_left_kidney</span> <span class="o">=</span> <span class="n">new_organ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_kidney</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">right_kidney</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property to emulate a safe get_or_create call to Organ. If no linked organ, a new record is</span>
<span class="sd">        created with sensible defaults and linked.</span>

<span class="sd">        :return: Organ record for the right kidney</span>
<span class="sd">        :rtype: wp4.compare.models.organ.Organ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">wp4.compare.models</span> <span class="k">import</span> <span class="n">Organ</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_right_kidney</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_right_kidney</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">organ_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">location__exact</span><span class="o">=</span><span class="n">RIGHT</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># Organ.DoesNotExist:</span>
                <span class="c1"># print(&quot;DEBUG: Donor.right_kidney() raised IndexError&quot;)</span>
                <span class="n">new_organ</span> <span class="o">=</span> <span class="n">Organ</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">RIGHT</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">new_organ</span><span class="o">.</span><span class="n">donor</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="n">new_organ</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_right_kidney</span> <span class="o">=</span> <span class="n">new_organ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_right_kidney</span>

    <span class="k">def</span> <span class="nf">_centre_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does a safe lookup for the centre_code of the retrieval_team. If no team set, returns 0</span>

<span class="sd">        :return: Centre code, or 0</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieval_team</span><span class="o">.</span><span class="n">centre_code</span>
        <span class="k">except</span> <span class="n">RetrievalTeam</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="n">centre_code</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_centre_code</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;centre_code&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Donor.make_trial_id"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Donor.make_trial_id">[docs]</a>    <span class="k">def</span> <span class="nf">make_trial_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the composite trial id string.</span>

<span class="sd">        :return: &#39;WP4cctnns&#39; - where:</span>

<span class="sd">                * cc = 2 digit centre code</span>
<span class="sd">                * t = single digit, 0 for online, 9 for offline randomisation</span>
<span class="sd">                * nn = 2 digit sequence number, starting at 01</span>
<span class="sd">                * s = (optional) single character denoting organ location, L for Left, R for Right</span>

<span class="sd">                If no centre_code set or a lack of sequence_number, returns &quot;No Trial ID Assigned (DOnnn)&quot;</span>
<span class="sd">                where nnn = the object&#39;s ID</span>

<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trial_id</span> <span class="o">=</span> <span class="s2">&quot;WP4&quot;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centre_code</span><span class="p">,</span> <span class="s1">&#39;02&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">centre_code</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">trial_id</span> <span class="o">=</span> <span class="s2">&quot;DO</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;03&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_offline</span><span class="p">:</span>
            <span class="n">trial_id</span> <span class="o">+=</span> <span class="s2">&quot;9&quot;</span> <span class="o">+</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_number</span><span class="p">,</span> <span class="s1">&#39;02&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trial_id</span> <span class="o">+=</span> <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_number</span><span class="p">,</span> <span class="s1">&#39;03&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trial_id</span></div>

    <span class="k">def</span> <span class="nf">_is_offline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if this was randomised using the relevant online or offline lists</span>

<span class="sd">        :return: True, if randomisation.list_code matches PAPER_EUROPE or PAPER_UNITED_KINGDOM</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomisation</span><span class="o">.</span><span class="n">list_code</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Randomisation</span><span class="o">.</span><span class="n">PAPER_EUROPE</span><span class="p">,</span> <span class="n">Randomisation</span><span class="o">.</span><span class="n">PAPER_UNITED_KINGDOM</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># We have no idea what error is being thrown or caught because there is no error!</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">is_offline</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_is_offline</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;is_offline&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_randomised</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the left_kidney.preservation value, and if PRESERVATION_NOT_SET, returns False.</span>

<span class="sd">        :return: True if the left kidney has been randomised</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_kidney</span><span class="o">.</span><span class="n">preservation</span> <span class="o">==</span> <span class="n">PRESERVATION_NOT_SET</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="n">is_randomised</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_is_randomised</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;is_randomised&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_count_eligible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Number of eligible kidneys from this donor.</span>

<span class="sd">        :return: 0, 1, or 2 kidneys, and -1 for not randomised</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eligible_kidney_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">left_kidney</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_kidney</span>
        <span class="n">right_kidney</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_kidney</span>
        <span class="k">if</span> <span class="n">left_kidney</span><span class="o">.</span><span class="n">preservation</span> <span class="o">!=</span> <span class="n">PRESERVATION_NOT_SET</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_recipients</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">left_kidney</span><span class="o">.</span><span class="n">transplantable</span><span class="p">:</span>
                <span class="n">eligible_kidney_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">right_kidney</span><span class="o">.</span><span class="n">transplantable</span><span class="p">:</span>
                <span class="n">eligible_kidney_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eligible_kidney_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">eligible_kidney_count</span>
    <span class="n">count_of_eligible_organs</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_count_eligible</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;count_of_eligible_organs&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Organ"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Organ">[docs]</a><span class="k">class</span> <span class="nc">Organ</span><span class="p">(</span><span class="n">AuditControlModelBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The focus of the trial, specifically a Kidney.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">donor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Donor</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal link to the Donor&quot;</span><span class="p">)</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR01 kidney location&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">LOCATION_CHOICES</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to LOCATION_CHOICES</span>

    <span class="c1"># Transplantation Form metadata</span>
    <span class="n">not_allocated_reason</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR31 not allocated because&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">admin_notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;OR50 Admin notes&quot;</span><span class="p">),</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">transplantation_notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;OR51 Transplantation notes&quot;</span><span class="p">),</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">transplantation_form_completed</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;OR99 Form complete&quot;</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Select Yes when you believe the form is complete and you have no more data to enter&quot;</span>
    <span class="p">)</span>
    <span class="n">trial_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR99 organ id&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Inspection data</span>
    <span class="n">GRAFT_DAMAGE_ARTERIAL</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#: Constant for GRAFT_DAMAGE_CHOICES</span>
    <span class="n">GRAFT_DAMAGE_VENOUS</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1">#: Constant for GRAFT_DAMAGE_CHOICES</span>
    <span class="n">GRAFT_DAMAGE_URETERAL</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1">#: Constant for GRAFT_DAMAGE_CHOICES</span>
    <span class="n">GRAFT_DAMAGE_PARENCHYMAL</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1">#: Constant for GRAFT_DAMAGE_CHOICES</span>
    <span class="n">GRAFT_DAMAGE_NONE</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1">#: Constant for GRAFT_DAMAGE_CHOICES</span>
    <span class="n">GRAFT_DAMAGE_OTHER</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1">#: Constant for GRAFT_DAMAGE_CHOICES</span>
    <span class="n">GRAFT_DAMAGE_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">GRAFT_DAMAGE_NONE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc01 None&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">GRAFT_DAMAGE_ARTERIAL</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc02 Arterial Damage&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">GRAFT_DAMAGE_VENOUS</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc03 Venous Damage&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">GRAFT_DAMAGE_URETERAL</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc04 Ureteral Damage&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">GRAFT_DAMAGE_PARENCHYMAL</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc05 Parenchymal Damage&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">GRAFT_DAMAGE_OTHER</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc06 Other Damage&quot;</span><span class="p">))</span>
    <span class="p">)</span>  <span class="c1">#: Organ graft_damage choices</span>

    <span class="n">WASHOUT_PERFUSION_HOMEGENOUS</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#: Constant for WASHOUT_PERFUSION_CHOICES</span>
    <span class="n">WASHOUT_PERFUSION_PATCHY</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1">#: Constant for WASHOUT_PERFUSION_CHOICES</span>
    <span class="n">WASHOUT_PERFUSION_BLUE</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1">#: Constant for WASHOUT_PERFUSION_CHOICES</span>
    <span class="n">WASHOUT_PERFUSION_UNKNOWN</span> <span class="o">=</span> <span class="mi">9</span>  <span class="c1">#: Constant for WASHOUT_PERFUSION_CHOICES</span>
    <span class="n">WASHOUT_PERFUSION_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># NHS Form has: Good, Fair, Poor, Patchy, Unknown</span>
        <span class="p">(</span><span class="n">WASHOUT_PERFUSION_HOMEGENOUS</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc07 Homogenous&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">WASHOUT_PERFUSION_PATCHY</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc08 Patchy&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">WASHOUT_PERFUSION_BLUE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc09 Blue&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">WASHOUT_PERFUSION_UNKNOWN</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc10 Unknown&quot;</span><span class="p">))</span>
    <span class="p">)</span>  <span class="c1">#: Organ washout_perfusion choices</span>

    <span class="n">removal</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR02 time out&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">renal_arteries</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR03 number of renal arteries&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">MaxValueValidator</span><span class="p">(</span><span class="mi">5</span><span class="p">)],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Number of arteries must be in range 0-5&quot;</span>
    <span class="p">)</span>
    <span class="n">graft_damage</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR04 renal graft damage&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">GRAFT_DAMAGE_CHOICES</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">GRAFT_DAMAGE_NONE</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to GRAFT_DAMAGE_CHOICES</span>
    <span class="n">graft_damage_other</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR05 other damage done&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">washout_perfusion</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR06 perfusion characteristics&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">WASHOUT_PERFUSION_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to WASHOUT_PERFUSION_CHOICES</span>
    <span class="n">transplantable</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR07 is transplantable&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;OR07h This answer can be amended after randomisation and saving of the form if necessary&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">not_transplantable_reason</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR08 not transplantable because&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Randomisation data</span>
    <span class="c1"># can_donate = models.BooleanField(&#39;Donor is eligible as DCD III and &gt; 50 years old&#39;) -- donor info!</span>
    <span class="c1"># can_transplant = models.BooleanField(&#39;&#39;) -- derived from left and right being transplantable</span>
    <span class="n">preservation</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">PRESERVATION_CHOICES</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">PRESERVATION_NOT_SET</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to PRESERVATION_CHOICES</span>

    <span class="c1"># Perfusion data</span>
    <span class="n">PATCH_SMALL</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#: Constant for PATCH_HOLDER_CHOICES</span>
    <span class="n">PATCH_LARGE</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1">#: Constant for PATCH_HOLDER_CHOICES</span>
    <span class="n">PATCH_DOUBLE_ARTERY</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1">#: Constant for PATCH_HOLDER_CHOICES</span>
    <span class="n">PATCH_HOLDER_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">PATCH_SMALL</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc12 Small&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">PATCH_LARGE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc13 Large&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">PATCH_DOUBLE_ARTERY</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc14 Double Artery&quot;</span><span class="p">))</span>
    <span class="p">)</span>  <span class="c1">#: Organ patch_holder choices</span>
    <span class="n">ARTIFICIAL_PATCH_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">PATCH_SMALL</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc12 Small&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">PATCH_LARGE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORc13 Large&quot;</span><span class="p">))</span>
    <span class="p">)</span>  <span class="c1">#: Organ artificial_patch_size choices</span>
    <span class="n">perfusion_possible</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR09 machine perfusion possible?&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">perfusion_not_possible_because</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR10 not possible because&#39;</span><span class="p">),</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">perfusion_started</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR11 machine perfusion&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">patch_holder</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR12 used patch holder&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">PATCH_HOLDER_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to PATCH_HOLDER_CHOICES</span>
    <span class="n">artificial_patch_used</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR13 artificial patch used&#39;</span><span class="p">),</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">artificial_patch_size</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR14 artificial patch size&#39;</span><span class="p">),</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">ARTIFICIAL_PATCH_CHOICES</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: Choices limited to ARTIFICIAL_PATCH_CHOICES</span>
    <span class="n">artificial_patch_number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR15 number of patches&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">MaxValueValidator</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
    <span class="p">)</span>  <span class="c1">#: Limited to range 1-2</span>
    <span class="n">oxygen_bottle_full</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR16 is oxygen bottle full&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">oxygen_bottle_open</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR17 oxygen bottle opened&#39;</span><span class="p">),</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">oxygen_bottle_changed</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR18 oxygen bottle changed&#39;</span><span class="p">),</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">oxygen_bottle_changed_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR19 oxygen bottle changed at&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">oxygen_bottle_changed_at_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">ice_container_replenished</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR20 ice container replenished&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">ice_container_replenished_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR21 ice container replenished at&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_between_1900_2050</span><span class="p">,</span> <span class="n">validate_not_in_future</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date must be fall within 1900-2050, and not be in the future&quot;</span>
    <span class="p">)</span>
    <span class="n">ice_container_replenished_at_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>
    <span class="n">perfusate_measurable</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">NullBooleanField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR22 perfusate measurable&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1">#: logistically possible to measure pO2 perfusate (use blood gas analyser)</span>
    <span class="n">perfusate_measure</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR23 value pO2&#39;</span><span class="p">),</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># TODO: Check the value range for perfusate_measure</span>
    <span class="n">perfusion_machine</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">Machine</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;OR24 perfusion machine&#39;</span><span class="p">),</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="c1"># Removed perfusion_file field as per Issue #208</span>

    <span class="c1"># Commonly filtered options</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">OrganModelForUserManager</span><span class="p">()</span>  <span class="c1">#: Default Organ manager</span>
    <span class="n">allocatable_objects</span> <span class="o">=</span> <span class="n">AllocatableModelForUserManager</span><span class="p">()</span>  <span class="c1">#: AllocatableModelForUserManager</span>
    <span class="n">open_objects</span> <span class="o">=</span> <span class="n">OpenOrganModelForUserManager</span><span class="p">()</span>  <span class="c1">#: OpenOrganModelForUserManager</span>
    <span class="n">closed_objects</span> <span class="o">=</span> <span class="n">ClosedOrganModelForUserManager</span><span class="p">()</span>  <span class="c1">#: ClosedOrganModelForUserManager</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ORm1 organ&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;ORm2 organs&#39;</span><span class="p">)</span>
        <span class="n">default_manager_name</span> <span class="o">=</span> <span class="s1">&#39;objects&#39;</span>
        <span class="n">base_manager_name</span> <span class="o">=</span> <span class="s1">&#39;objects&#39;</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;view_organ&quot;</span><span class="p">,</span> <span class="s2">&quot;Can only view the data&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;restrict_to_national&quot;</span><span class="p">,</span> <span class="s2">&quot;Can only use data from the same location country&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;restrict_to_local&quot;</span><span class="p">,</span> <span class="s2">&quot;Can only use data from a specific location&quot;</span><span class="p">),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Organ.country_for_restriction"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Organ.country_for_restriction">[docs]</a>    <span class="k">def</span> <span class="nf">country_for_restriction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the country to be used for geographic restriction of this data.</span>

<span class="sd">        Organs move around, thus we have to look through their likely locations in reverse to determine where it is</span>

<span class="sd">        :return: Int: Value from list in Locations.Models. Should be in range [1,4,5]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_recipient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_recipient</span><span class="o">.</span><span class="n">country_for_restriction</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">country_for_restriction</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">donor</span><span class="o">.</span><span class="n">country_for_restriction</span><span class="p">()</span></div>

<div class="viewcode-block" id="Organ.location_for_restriction"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Organ.location_for_restriction">[docs]</a>    <span class="k">def</span> <span class="nf">location_for_restriction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the location to be used for geographic restriction of this data</span>

<span class="sd">        Organs move around, thus we have to look through their likely locations in reverse to determine where it is</span>

<span class="sd">        :return: Int: Hospital object id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_recipient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_recipient</span><span class="o">.</span><span class="n">location_for_restriction</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">location_for_restriction</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">donor</span><span class="o">.</span><span class="n">location_for_restriction</span><span class="p">()</span></div>

<div class="viewcode-block" id="Organ.clean"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Organ.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the following fields of data if their corresponding unknown flag is set to True</span>

<span class="sd">        * oxygen_bottle_changed_at</span>
<span class="sd">        * ice_container_replenished_at</span>

<span class="sd">        Error if:</span>

<span class="sd">        * transplantable is False, and not_transplantable_reason is empty (ORv01)</span>
<span class="sd">        * perfusion_possible is False, and perfusion_not_possible_because is empty (ORv02)</span>
<span class="sd">        * perfusion_possible is True, and perfusion_started is not set (ORv03)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clean the fields that at Not Known</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">oxygen_bottle_changed_at_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oxygen_bottle_changed_at</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_container_replenished_at_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ice_container_replenished_at</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transplantable</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_transplantable_reason</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORv01 Please enter a reason for not being transplantable&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfusion_possible</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfusion_not_possible_because</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORv02 Please enter a reason perfusion wasn&#39;t possible&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfusion_possible</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfusion_started</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;ORv03 Please enter the time perfusion started at&quot;</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_safe_recipient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to return either the related Recipient record, or a safe value of None,</span>
<span class="sd">        without the drama of exceptions when it doesn&#39;t exist</span>

<span class="sd">        :rtype: wp4.compare.models.transplantation.Recipient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipient</span>  <span class="c1"># We have a recipient</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># RelatedObjectDoesNotExist</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="n">safe_recipient</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_safe_recipient</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;safe_recipient&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_final_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Work out if there are any OrganAllocations, and then return the latest one</span>
<span class="sd">        </span>
<span class="sd">        TODO: Rename this as &quot;latest allocation&quot;. The `allocation` property links to the final allocation</span>

<span class="sd">        :return: OrganAllocation, or None</span>
<span class="sd">        :rtype: wp4.compare.models.transplantation.OrganAllocation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">organallocation_set</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s1">&#39;transplant_hospital&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
    <span class="n">final_allocation</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_final_allocation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;final_allocation&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Organ.serious_events_only"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Organ.serious_events_only">[docs]</a>    <span class="k">def</span> <span class="nf">serious_events_only</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_serious</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Organ.non_serious_events_only"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Organ.non_serious_events_only">[docs]</a>    <span class="k">def</span> <span class="nf">non_serious_events_only</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">is_serious</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="Organ.make_trial_id"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.Organ.make_trial_id">[docs]</a>    <span class="k">def</span> <span class="nf">make_trial_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the Donor Trial ID combined with the Location (L or R) for the Organ</span>

<span class="sd">        :return: &#39;WP4cctnns&#39;</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG: Organ.make_trial_id: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donor</span><span class="o">.</span><span class="n">trial_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">donor</span><span class="o">.</span><span class="n">trial_id</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span></div>

    <span class="k">def</span> <span class="nf">_is_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allocation status</span>

<span class="sd">        Determine if an organ has been allocated. Allocated means:</span>

<span class="sd">        * To a recipient at a project site</span>
<span class="sd">        * Final allocation is to a non-project site</span>

<span class="sd">        :return: True, if either of those criteria are met</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_recipient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># We have a recipient, which can only occur if at a project site</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">reallocated</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">transplant_hospital</span><span class="o">.</span><span class="n">is_project_site</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># We can&#39;t say not-reallocated without saving a transplant hospital as well</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">is_allocated</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_is_allocated</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;is_allocated&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_explain_is_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allocation status description: An explanation as to the allocation status for this organ</span>

<span class="sd">        :return: Message describing status of allocation</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_allocated</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_recipient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Allocated to Recipient&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">reallocated</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">transplant_hospital</span><span class="o">.</span><span class="n">is_project_site</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Allocated to a non-project site&quot;</span>  <span class="c1"># This should be caught by not_allocated_reason</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_allocated_reason</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Not allocated because: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_allocated_reason</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;No allocations created (and no explanation as yet)&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_allocation</span><span class="o">.</span><span class="n">reallocated</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;ERROR: last allocation shows a reallocation&quot;</span>  <span class="c1"># This shouldn&#39;t occur!</span>

            <span class="k">return</span> <span class="s2">&quot;Re-allocation status not yet set&quot;</span>  <span class="c1"># Possible for a form that is WIP</span>

        <span class="k">return</span> <span class="s2">&quot;ERROR: Unknown allocation status (test data?)&quot;</span>
    <span class="n">explain_is_allocated</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_explain_is_allocated</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;explain_is_allocated&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">explain_closed_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Work out why this form was closed, and display a suitable summary message</span>

<span class="sd">        NOT IMPLEMENTED (yet)</span>

<span class="sd">        :return: Message describing the likely cause for the form being closed</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Write this function</span>
        <span class="k">return</span> <span class="s2">&quot;Unknown closed status&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">was_cold_stored</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A kidney should be flagged as COLD STORED when (1) OR (2) where</span>
<span class="sd">        (1) if wp4.compare.models.organ.Organ - perfusion_possible (django.db.models.NullBooleanField) – “OR09 machine</span>
<span class="sd">        perfusion possible?” is FALSE</span>
<span class="sd">        (2) if &quot;Was the kidney cold stored because of a machine problem&quot; in the Transplantation form is TRUE</span>

<span class="sd">        See discussion in Issue 166 for more detail</span>

<span class="sd">        :return: True if criteria are met, False otherwise</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfusion_possible</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_recipient</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_recipient</span><span class="o">.</span><span class="n">organ_cold_stored</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_reallocation_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of organ allocations where reallocated is true</span>

<span class="sd">        :return: Count of reallocations</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">allocation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">organallocation_set</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">allocation</span><span class="o">.</span><span class="n">reallocated</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span>

    <span class="n">reallocation_count</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_reallocation_count</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;reallocation_count&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_graft_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan through the follow ups to determine if there is a graft failure reported for this organ. We can afford</span>
<span class="sd">        to presume that if something fails in this sequence there is no point looking for later related objects.</span>

<span class="sd">        :return: 0, if no failures. 1 for Initial, 2 for Month 3, 3 for Month 6, and 4 for Month 12</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">followup_initial</span><span class="o">.</span><span class="n">graft_failure</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">followup_3m</span><span class="o">.</span><span class="n">graft_failure</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">followup_6m</span><span class="o">.</span><span class="n">graft_failure</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">followup_1y</span><span class="o">.</span><span class="n">graft_failure</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">4</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="n">graft_failed</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_graft_failed</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;graft_failed&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_followup_3m_begin_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the date that the final follow up can begin by. This is the randomisation date + 70 days</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donor</span><span class="o">.</span><span class="n">randomisation</span><span class="o">.</span><span class="n">allocated_on</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">70</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="n">followup_3m_begin_by</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_followup_3m_begin_by</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;followup_3m_begin_by&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_followup_3m_completed_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the date that the final follow up should be completed by. This is the randomisation date + 91 + 21 days</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donor</span><span class="o">.</span><span class="n">randomisation</span><span class="o">.</span><span class="n">allocated_on</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">112</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="n">followup_3m_completed_by</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_followup_3m_completed_by</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;followup_3m_completed_by&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_followup_6m_begin_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the date that the final follow up can begin by. This is the randomisation date + 150 days</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donor</span><span class="o">.</span><span class="n">randomisation</span><span class="o">.</span><span class="n">allocated_on</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">150</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="n">followup_6m_begin_by</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_followup_6m_begin_by</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;followup_6m_begin_by&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_followup_6m_completed_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the date that the final follow up should be completed by. This is the randomisation date + 182 + 32 days</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donor</span><span class="o">.</span><span class="n">randomisation</span><span class="o">.</span><span class="n">allocated_on</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">214</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="n">followup_6m_completed_by</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_followup_6m_completed_by</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;followup_6m_completed_by&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_followup_final_begin_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the date that the final follow up can begin by. This is the randomisation date + 300 days</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donor</span><span class="o">.</span><span class="n">randomisation</span><span class="o">.</span><span class="n">allocated_on</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">300</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="n">followup_final_begin_by</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_followup_final_begin_by</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;followup_final_begin_by&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_followup_final_completed_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the date that the final follow up should be completed by. This is the randomisation date + 365+65 days</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">donor</span><span class="o">.</span><span class="n">randomisation</span><span class="o">.</span><span class="n">allocated_on</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">430</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="n">followup_final_completed_by</span> <span class="o">=</span> <span class="n">cached_property</span><span class="p">(</span><span class="n">_followup_final_completed_by</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;followup_final_completed_by&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_id</span></div>


<div class="viewcode-block" id="ProcurementResource"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.ProcurementResource">[docs]</a><span class="k">class</span> <span class="nc">ProcurementResource</span><span class="p">(</span><span class="n">AuditControlModelBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repeatable list of resources used during organ extraction. Primarily distinguished by the type. This is an</span>
<span class="sd">    extension of the Procurement form for each organ. Geographical restrictions on this are mostly moot, but defer to</span>
<span class="sd">    Organ if needed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DISPOSABLES</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span>  <span class="c1">#: Constant for TYPE_CHOICES</span>
    <span class="n">EXTRA_CANNULA_SMALL</span> <span class="o">=</span> <span class="s2">&quot;C-SM&quot;</span>  <span class="c1">#: Constant for TYPE_CHOICES</span>
    <span class="n">EXTRA_CANNULA_LARGE</span> <span class="o">=</span> <span class="s2">&quot;C-LG&quot;</span>  <span class="c1">#: Constant for TYPE_CHOICES</span>
    <span class="n">EXTRA_PATCH_HOLDER_SMALL</span> <span class="o">=</span> <span class="s2">&quot;PH-SM&quot;</span>  <span class="c1">#: Constant for TYPE_CHOICES</span>
    <span class="n">EXTRA_PATCH_HOLDER_LARGE</span> <span class="o">=</span> <span class="s2">&quot;PH-LG&quot;</span>  <span class="c1">#: Constant for TYPE_CHOICES</span>
    <span class="n">EXTRA_DOUBLE_CANNULA_SET</span> <span class="o">=</span> <span class="s2">&quot;DB-C&quot;</span>  <span class="c1">#: Constant for TYPE_CHOICES</span>
    <span class="n">PERFUSATE_SOLUTION</span> <span class="o">=</span> <span class="s2">&quot;P&quot;</span>  <span class="c1">#: Constant for TYPE_CHOICES</span>
    <span class="n">TYPE_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">DISPOSABLES</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;PRc01 Disposables&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">EXTRA_CANNULA_SMALL</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;PRc02 Extra cannula small (3mm)&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">EXTRA_CANNULA_LARGE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;PRc03 Extra cannula large (5mm)&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">EXTRA_PATCH_HOLDER_SMALL</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;PRc04 Extra patch holder small&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">EXTRA_PATCH_HOLDER_LARGE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;PRc05 Extra patch holder large&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">EXTRA_DOUBLE_CANNULA_SET</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;PRc06 Extra double cannula set&quot;</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">PERFUSATE_SOLUTION</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;PRc07 Perfusate solution&quot;</span><span class="p">))</span>
    <span class="p">)</span>  <span class="c1">#: ProcurementResource type choices</span>

    <span class="n">organ</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Organ</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;PR01 related kidney&#39;</span><span class="p">))</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;PR02 resource used&#39;</span><span class="p">),</span> <span class="n">choices</span><span class="o">=</span><span class="n">TYPE_CHOICES</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">lot_number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;PR03 lot number&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">expiry_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;PR04 expiry date&#39;</span><span class="p">),</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">expiry_date_unknown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal unknown flag&quot;</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">ProcurementResourceModelForUserManager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;PRm1 procurement resource&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;PRm2 procurement resources&#39;</span><span class="p">)</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;view_procurementresource&quot;</span><span class="p">,</span> <span class="s2">&quot;Can only view the data&quot;</span><span class="p">),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ProcurementResource.clean"><a class="viewcode-back" href="../../../../source/generated/wp4.compare.models.donor.html#wp4.compare.models.donor.ProcurementResource.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the value of expiry_date if marked as unknown</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clean the fields that at Not Known</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiry_date_unknown</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expiry_date</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_type_display</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; for &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">organ</span><span class="o">.</span><span class="n">trial_id</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Carl Marshall.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'0.8.2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>