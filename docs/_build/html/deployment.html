

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-GB" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en-GB" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Deployment &mdash; COPE DB 0.9.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Development" href="development.html" />
    <link rel="prev" title="COPE DB User Manual" href="user_manual.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> COPE DB
          

          
          </a>

          
            
            
              <div class="version">
                0.9.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="user_manual.html">COPE DB User Manual</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#production-cope-nds">Production (cope.nds)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#maintenance">Maintenance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-the-app">Updating the App</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#historical-setup-notes">Historical Setup Notes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#access">Access</a></li>
<li class="toctree-l4"><a class="reference internal" href="#software-stack">Software stack</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#user-setup">User setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#virtualenvwrapper-installation">VirtualEnvWrapper Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#site-setup">Site setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssl-certificate">SSL Certificate</a></li>
<li class="toctree-l4"><a class="reference internal" href="#migrating-to-python-3-and-postgres">Migrating to Python 3 and Postgres</a></li>
<li class="toctree-l4"><a class="reference internal" href="#supervisor-config">Supervisor Config</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging-supervisor">Debugging Supervisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reset-backup">Reset backup:</a></li>
<li class="toctree-l4"><a class="reference internal" href="#migrating-from-lts-14-04-to-lts-16-04-1">Migrating from LTS 14.04 to LTS 16.04.1</a></li>
<li class="toctree-l4"><a class="reference internal" href="#migrating-from-lts-16-04-1-to-lts-18-01">Migrating from LTS 16.04.1 to LTS 18.01</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#footnotes-for-production">Footnotes for Production</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#test-staging-dev-nds">Test/Staging (dev.nds)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#todo">TODO</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#development-localhost">Development (localhost)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/wp4_design.html">Design - WP4:Compare</a></li>
<li class="toctree-l1"><a class="reference internal" href="design/wp7_design.html">Design - WP7:Biobanking</a></li>
<li class="toctree-l1"><a class="reference internal" href="models/index.html">Data Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">COPE DB</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Deployment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/deployment.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deployment">
<h1>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h1>
<p>Outline instructions for deployment of COPE DB app in Production, Testing, and Development environments.</p>
<div class="section" id="production-cope-nds">
<h2>Production (cope.nds)<a class="headerlink" href="#production-cope-nds" title="Permalink to this headline">¶</a></h2>
<p>Current production server setup</p>
<ul class="simple">
<li><p><strong>FQDN:</strong> cope.nds.ox.ac.uk</p></li>
<li><p><strong>OS:</strong> Ubuntu 18.04.2 LTS</p></li>
<li><p><strong>eth0:</strong> 163.1.69.61</p></li>
<li><p><strong>App Framework:</strong> Python 3.7 + Django 2.2 via nginX and gunicorn.</p></li>
<li><p><strong>Code repository:</strong> https://github.com/ouh-churchill/COPE</p></li>
</ul>
<div class="section" id="maintenance">
<h3>Maintenance<a class="headerlink" href="#maintenance" title="Permalink to this headline">¶</a></h3>
<p>Periodically there are maintenance tasks to do, such as:</p>
<ul class="simple">
<li><p>Update the OS libraries and packages</p></li>
<li><p>Compress the DB backups</p></li>
<li><p>Remember also to check the expiry date of the SSL Certificate, as this will need periodic replacement.</p></li>
</ul>
<p>OS Updates are handled both by Canonical Livepatch, and manual updates
via the following steps (<a class="reference external" href="#">https://help.ubuntu.com/community/AptGet/Howto</a>)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">copeuser</span><span class="nd">@cope</span><span class="o">.</span><span class="n">nds</span><span class="o">.</span><span class="n">ox</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">autoclean</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">upgrade</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">autoremove</span>
<span class="n">sudo</span> <span class="n">shutdown</span> <span class="o">-</span><span class="n">r</span> <span class="n">now</span>
</pre></div>
</div>
<p>Take note of which packages are in the upgrade as these may have consequences for the virtualenv setup of the Cope App itself (e.g. python version changes). If there is a breaking upgrade, such as the fairly common one of a minor version update to Python 3, then a wipe of the virtualenv (not the project folder!) folder and rebuilt as in the installation should solve this fairly trivially.</p>
<p><strong>This should be looked at monthly, or whenever there is an urgent security alert for a dependancy.</strong></p>
</div>
<div class="section" id="updating-the-app">
<h3>Updating the App<a class="headerlink" href="#updating-the-app" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Activate the virtualenv <code class="docutils literal notranslate"><span class="pre">workon</span> <span class="pre">cope</span></code></p></li>
<li><p>Move into the repository directory for most tasks <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">cope-repo</span></code></p></li>
<li><p>Get the latest updates from the central repository <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span> <span class="pre">--all</span></code></p></li>
<li><p>Checkout the relevant (possibly tagged - e.g. <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">0.4.6</span></code>) release <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span></code></p></li>
<li><p>Update the application libraries <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements/production.txt</span></code></p></li>
<li><p>Check things are working so far <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">check</span></code></p></li>
<li><p>Apply any necessary migrations <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code></p></li>
<li><p>Gather the staticfiles up <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">collectstatic</span></code></p></li>
<li><p>Apply the locale updates <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">compilemessages</span></code></p></li>
<li><p>Check things are working so far II <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">check</span></code></p></li>
<li><p>Start the supervisor console to reload the changes <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">supervisorctl</span></code>…</p></li>
<li><p>and then <code class="docutils literal notranslate"><span class="pre">restart</span> <span class="pre">cope-django</span></code></p></li>
<li><p>…and all should be fine.</p></li>
</ul>
<div class="section" id="troubleshooting">
<h4>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h4>
<p>When things do not go to plan, we want to find out what we can. There’s no debug mode on the production server, so it’s into the error logs for information. Logs from supervisord are found via: <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/var/log/supervisor/</span></code>. Unfortunately stack traces aren’t captured here (for example on a Server Error), so more work needs to be done to help the monitoring of this server.</p>
</div>
</div>
<div class="section" id="historical-setup-notes">
<h3>Historical Setup Notes<a class="headerlink" href="#historical-setup-notes" title="Permalink to this headline">¶</a></h3>
<p>An Ubuntu 14.04 LTS Server virtual machine was initially created and hosted by MSD-IT Services. This is the unmanaged service, which means that we are responsible for its patching and upkeep. Initial steps so far have been to change the user account password (u: copeuser - p: in CM’s password safe). Installing ssh keys will happen soon. Access
to the server should be via ssh (only from Oxford network, including vpn) and via the VMWare web console (oxford network
only - <a class="reference external" href="#">https://fibula.msd.ox.ac.uk/</a>)</p>
<p>Setup is going to be loosely based on the guides from <a class="reference external" href="#">https://www.chicagodjango.com/blog/new-server-setup-part-1/</a> and
<a class="reference external" href="#">https://www.chicagodjango.com/blog/new-django-server-setup-part-2/</a> as these are inline with the best practice information
in the Two Scoops of Django 1.8: Best Practices guide (see Chapter 31). More useful though is the guide from
<a class="reference external" href="#">http://michal.karzynski.pl/blog/2013/06/09/django-nginx-gunicorn-virtualenv-supervisor/</a>.</p>
<div class="section" id="access">
<h4>Access<a class="headerlink" href="#access" title="Permalink to this headline">¶</a></h4>
<p>Fresh from the base OS install we had access via <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">copeuser&#64;cope.nds.ox.ac.uk</span></code>, and using a password. Stage two is to install our SSH key (e.g. iMac&#64;Home) for access.</p>
<p>We need to generate an ssh key for the server to register with github for
access to the repository (<a class="reference external" href="#">https://github.com/ouh-churchill/COPE</a>). Help is at <a class="reference external" href="#">https://help.ubuntu.com/community/SSH/OpenSSH/Keys</a> . To whit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>copeuser@cope:~$ mkdir ~/.ssh
copeuser@cope:~$ chmod 700 ~/.ssh
copeuser@cope:~$ ssh-keygen -t rsa -b 4096
Generating public/private rsa key pair.
Enter file in which to save the key (/home/copeuser/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/copeuser/.ssh/id_rsa.
Your public key has been saved in /home/copeuser/.ssh/id_rsa.pub.
</pre></div>
</div>
<p>This set of keys is passphrase free because of the automated usage (i.e. scripts using it to access things).</p>
<p>Copy own .pub key to the server (SFTP), and then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="n">id_rsa</span><span class="o">.</span><span class="n">pub</span> <span class="o">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">carl_imac</span><span class="o">.</span><span class="n">id_rsa</span><span class="o">.</span><span class="n">pub</span>
<span class="n">cat</span> <span class="n">carl_imac</span><span class="o">.</span><span class="n">id_rsa</span><span class="o">.</span><span class="n">pub</span> <span class="o">&gt;&gt;</span> <span class="n">authorized_keys</span>
</pre></div>
</div>
<p>Also, minor edit to <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">vi</span> <span class="pre">/etc/ssh/sshd_config</span></code> so that <code class="docutils literal notranslate"><span class="pre">AuthorizedKeysFile</span> <span class="pre">%h/.ssh/authorized_keys</span></code> is uncommented. Sudo usage will continue to require password confirmation, however we can now login without needing the password from SSH.</p>
<p>I have added the server’s pub key to my list of Github keys, so that it can log in as <code class="docutils literal notranslate"><span class="pre">marshalc</span></code>. This will need changing to the next maintainer of this system’s account.</p>
</div>
<div class="section" id="software-stack">
<h4>Software stack<a class="headerlink" href="#software-stack" title="Permalink to this headline">¶</a></h4>
<p>Initial choices are Nginx (for static), Gunicorn (for application), and SQLite (for datastore). System’s version of python is 2.7.6, which is currently fine for use, so will skip installing a local instance of python (this is changed later when the project moved to python 3 to maintain security patching). Not requiring any particular caching installation at this time either, so in the interests of KISS, we will install as little as possible.</p>
</div>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>Follow guide plus above we have:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove some default processes and packages that we don&#39;t need to reduce server exposure</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="n">tomcat7</span> <span class="n">tomcat7</span><span class="o">-</span><span class="n">docs</span> <span class="n">tomcat7</span><span class="o">-</span><span class="n">admin</span> <span class="n">tomcat7</span><span class="o">-</span><span class="n">examples</span> <span class="n">default</span><span class="o">-</span><span class="n">jdk</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="n">postgresql</span> <span class="n">postgresql</span><span class="o">-</span><span class="mf">9.3</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">client</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="mf">9.3</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">common</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">common</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">contrib</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">contrib</span><span class="o">-</span><span class="mf">9.3</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">doc</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">doc</span><span class="o">-</span><span class="mf">9.3</span>

<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">pip</span> <span class="n">python</span><span class="o">-</span><span class="n">virtualenv</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">python</span> <span class="n">python</span><span class="o">-</span><span class="n">dev</span> <span class="n">python</span><span class="o">-</span><span class="n">setuptools</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">build</span><span class="o">-</span><span class="n">essential</span>    <span class="c1"># Was redundant because the above had already got this</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">git</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">supervisor</span> <span class="n">postfix</span> <span class="n">ntp</span>
</pre></div>
</div>
<p>Postfix will ask for some config, so it is set to use a mail-relay/smarthost for sending messages, and then::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setting</span> <span class="n">myhostname</span><span class="p">:</span> <span class="n">cope</span><span class="o">.</span><span class="n">nds</span>
<span class="n">setting</span> <span class="n">alias</span> <span class="n">maps</span>
<span class="n">setting</span> <span class="n">alias</span> <span class="n">database</span>
<span class="n">changing</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mailname</span> <span class="n">to</span> <span class="n">cope</span><span class="o">.</span><span class="n">nds</span><span class="o">.</span><span class="n">ox</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span>
<span class="n">setting</span> <span class="n">myorigin</span>
<span class="n">setting</span> <span class="n">destinations</span><span class="p">:</span> <span class="n">cope</span><span class="o">.</span><span class="n">nds</span><span class="o">.</span><span class="n">ox</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span><span class="p">,</span> <span class="n">cope</span><span class="o">.</span><span class="n">nds</span><span class="p">,</span> <span class="n">localhost</span><span class="o">.</span><span class="n">nds</span><span class="p">,</span> <span class="n">localhost</span>
<span class="n">setting</span> <span class="n">relayhost</span><span class="p">:</span> <span class="n">smtp</span><span class="o">.</span><span class="n">ox</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span>
</pre></div>
</div>
<p>Current info on the Oxford smarthost is at <a class="reference external" href="#">http://help.it.ox.ac.uk/network/smtp/relay/index</a></p>
<p>Grab the file server and some other useful apps::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nginx</span> <span class="n">sqlite3</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">pwgen</span> <span class="n">htop</span> <span class="n">curl</span> <span class="n">rsync</span> <span class="n">nmon</span> <span class="n">dnsutils</span> \
      <span class="n">screen</span> <span class="n">tmux</span> <span class="n">ack</span><span class="o">-</span><span class="n">grep</span> <span class="n">whois</span> <span class="n">sshfs</span> <span class="n">openssh</span><span class="o">-</span><span class="n">client</span> \
      <span class="n">openssh</span><span class="o">-</span><span class="n">server</span> <span class="n">libssl</span><span class="o">-</span><span class="n">dev</span> <span class="n">libreadline</span><span class="o">-</span><span class="n">dev</span> <span class="n">aptitude</span> <span class="n">fail2ban</span> \
      <span class="n">libxml2</span><span class="o">-</span><span class="n">dev</span> <span class="n">libxslt</span><span class="o">-</span><span class="n">dev</span> <span class="n">graphviz</span> <span class="n">graphviz</span><span class="o">-</span><span class="n">dev</span> <span class="n">csstidy</span> \
      <span class="n">emacs23</span><span class="o">-</span><span class="n">nox</span> <span class="n">vim</span> <span class="n">ncurses</span><span class="o">-</span><span class="n">dev</span> <span class="n">iotop</span> <span class="n">nload</span> <span class="n">iptraf</span><span class="o">-</span><span class="n">ng</span> <span class="n">nethogs</span> <span class="n">tree</span>
</pre></div>
</div>
<p>Note that we got sqlite3 in place of the postgres option from the guide.</p>
<p>We want to stop nginx from being run at server startup though, and let Supervisor handle that later on, so we need to disable the link for init.d ::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rm</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc2</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">S19postgresql</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc2</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">S92tomcat7</span>     <span class="c1"># CLEANUP FROM EARLIER</span>
<span class="n">sudo</span> <span class="n">mv</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc2</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">S20nginx</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc2</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">K20nginx</span>
<span class="n">update</span><span class="o">-</span><span class="n">rc</span><span class="o">.</span><span class="n">d</span> <span class="n">script</span> <span class="n">defaults</span>
</pre></div>
</div>
</div>
<div class="section" id="user-setup">
<h4>User setup<a class="headerlink" href="#user-setup" title="Permalink to this headline">¶</a></h4>
<p>We’re not using the application user from the guide here, but using the nginx defined www-data user as the application
user::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span>
<span class="n">sudo</span> <span class="n">groupadd</span> <span class="o">--</span><span class="n">system</span> <span class="n">worker</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="n">root</span><span class="p">:</span><span class="n">worker</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">775</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span>
<span class="n">sudo</span> <span class="n">useradd</span> <span class="o">--</span><span class="n">system</span> <span class="o">--</span><span class="n">gid</span> <span class="n">worker</span> <span class="o">--</span><span class="n">shell</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span> <span class="o">--</span><span class="n">home</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span> <span class="n">cope</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="n">user</span>
<span class="n">sudo</span> <span class="n">usermod</span> <span class="o">-</span><span class="n">aG</span> <span class="n">worker</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span>        <span class="c1"># This is the application_user from the nginx config</span>
<span class="n">sudo</span> <span class="n">usermod</span> <span class="o">-</span><span class="n">aG</span> <span class="n">worker</span> <span class="n">copeuser</span>        <span class="c1"># This is the MSD-IT created user account</span>
<span class="n">sudo</span> <span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;echo &quot;umask 002&quot; &gt;&gt; /etc/profile&#39;</span>
</pre></div>
</div>
<p>Remember to logout and back in again here so that any further work done as <code class="docutils literal notranslate"><span class="pre">copeuser</span></code> will have the <code class="docutils literal notranslate"><span class="pre">worker</span></code> group rights and therefore won’t need sudo all the time.</p>
</div>
<div class="section" id="virtualenvwrapper-installation">
<h4>VirtualEnvWrapper Installation<a class="headerlink" href="#virtualenvwrapper-installation" title="Permalink to this headline">¶</a></h4>
<p>The wrapper isn’t installed as part of the apt-get process, so we do this following the instructions from
<a class="reference external" href="#">http://virtualenvwrapper.readthedocs.org/en/latest/install.html#basic-installation</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">virtualenvwrapper</span>
<span class="n">vi</span> <span class="o">~/.</span><span class="n">bashrc</span>
</pre></div>
</div>
<p>Appending to <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setup VirtualEnvWrapper for this user</span>
<span class="n">export</span> <span class="n">WORKON_HOME</span><span class="o">=/</span><span class="n">sites</span><span class="o">/.</span><span class="n">virtualenvs</span>
<span class="n">export</span> <span class="n">PROJECT_HOME</span><span class="o">=/</span><span class="n">sites</span>
<span class="n">source</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">virtualenvwrapper</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Then returning and:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">~/.</span><span class="n">bashrc</span>
</pre></div>
</div>
</div>
<div class="section" id="site-setup">
<h4>Site setup<a class="headerlink" href="#site-setup" title="Permalink to this headline">¶</a></h4>
<p>Create a new virtualenv project with <code class="docutils literal notranslate"><span class="pre">mkproject</span> <span class="pre">cope</span></code>. Note that the <code class="docutils literal notranslate"><span class="pre">bin/</span></code>, <code class="docutils literal notranslate"><span class="pre">lib/</span></code> directories are in the
<code class="docutils literal notranslate"><span class="pre">/sites/.virtualenvs/cope/</span></code> folder.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>copeuser@cope:~$ mkproject cope
New python executable in cope/bin/python
Installing setuptools, pip...done.
virtualenvwrapper.user_scripts creating /sites/.virtualenvs/cope/bin/predeactivate
virtualenvwrapper.user_scripts creating /sites/.virtualenvs/cope/bin/postdeactivate
virtualenvwrapper.user_scripts creating /sites/.virtualenvs/cope/bin/preactivate
virtualenvwrapper.user_scripts creating /sites/.virtualenvs/cope/bin/postactivate
virtualenvwrapper.user_scripts creating /sites/.virtualenvs/cope/bin/get_env_details

# NB: cwd is /sites/cope
git clone git@github.com:AllyBradley/COPE.git cope_repo
git checkout production
mkdir -p var/log var/run etc/nginx/sites-available htdocs/media etc/gunicorn
ln -s /sites/.virtualenvs/cope/lib ./lib
ln -s /sites/.virtualenvs/cope/bin ./bin
</pre></div>
</div>
<p>Now we have: <code class="docutils literal notranslate"><span class="pre">/sites/{{ENVIRONMENT_ROOT}}/{{PROJECT_ROOT}}/</span></code> as <code class="docutils literal notranslate"><span class="pre">/sites/cope/cope_repo</span></code> (or in terms of the online guide we have: <code class="docutils literal notranslate"><span class="pre">/sites/{{site_name}}/{{proj_name}}/</span></code>)</p>
<p>Tweak nginx core config with <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">vi</span> <span class="pre">/etc/nginx/nginx.conf</span></code> and add <code class="docutils literal notranslate"><span class="pre">daemon</span> <span class="pre">off;</span></code> near the top few lines, then we can link to the conf files from the repository. First to the local folder, then to the system folder.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># NB: cwd is /sites/cope</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span><span class="o">/</span><span class="n">cope_repo</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">cope</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">cope</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">cope</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">cope</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">cope</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span><span class="o">/</span><span class="n">cope</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">rm</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span><span class="o">/</span><span class="n">default</span>

<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span><span class="o">/</span><span class="n">cope_repo</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span><span class="o">/</span><span class="n">cope_repo</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">django</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">django</span><span class="o">.</span><span class="n">conf</span>

<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span><span class="o">/</span><span class="n">cope_repo</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn_start</span><span class="o">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn_start</span><span class="o">.</span><span class="n">sh</span>
<span class="n">chmod</span> <span class="mi">775</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span><span class="o">/</span><span class="n">cope_repo</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn_start</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Now we need to get some application code install done so that things like gunicorn are actually installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># NB: cwd is /sites/cope</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">cope_repo</span><span class="o">/</span><span class="n">requirements</span><span class="o">/</span><span class="n">production</span><span class="o">.</span><span class="n">txt</span>
<span class="n">cd</span> <span class="n">cope</span><span class="o">-</span><span class="n">repo</span><span class="o">/</span>
<span class="n">chmod</span> <span class="mi">775</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span>
<span class="n">cp</span> <span class="n">local</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">template</span> <span class="n">local</span><span class="o">.</span><span class="n">env</span>
<span class="n">vi</span> <span class="n">local</span><span class="o">.</span><span class="n">env</span>                           <span class="c1"># set debug to off, and then create a secret key, and set Static and Media root to the htdocs directory</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">check</span>                 <span class="c1"># Should return 0 errors</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">collectstatic</span>         <span class="c1"># NB: Should point to the htdocs folder and ask for confirmation</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">createsuperuser</span>       <span class="c1"># superuser is &#39;carl&#39;</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">loaddata</span> <span class="n">config</span><span class="o">/</span><span class="n">fixtures</span><span class="o">/</span><span class="mi">01</span><span class="n">_hospitals</span><span class="o">.</span><span class="n">json</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">loaddata</span> <span class="n">config</span><span class="o">/</span><span class="n">fixtures</span><span class="o">/</span><span class="mi">02</span><span class="n">_persons</span><span class="o">.</span><span class="n">json</span>
<span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">loaddata</span> <span class="n">config</span><span class="o">/</span><span class="n">fixtures</span><span class="o">/</span><span class="mi">03</span><span class="n">_gradings</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>Now do a quick sweep of the files to ensure permissions are suitably set so far…</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="n">worker</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="n">g</span><span class="o">+</span><span class="n">w</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span>
<span class="n">sudo</span> <span class="n">find</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">cope</span> <span class="o">-</span><span class="nb">type</span> <span class="n">d</span> <span class="o">-</span><span class="n">exec</span> <span class="n">chmod</span> <span class="n">g</span><span class="o">+</span><span class="n">s</span> <span class="p">{}</span> \<span class="p">;</span>
</pre></div>
</div>
<p>Generally speaking, we try to give each file and directory the minimum permissions necessary. We try to abide by the following permission guidelines.</p>
<ul class="simple">
<li><p>Python (*.py) files should have 664 set on them UNLESS a user is to directly execute the Python file from the command line as a script (i.e. manage.py). Executable Python scripts should be set to 775.</p></li>
<li><p>Script (*.sh) files should be set to 775.</p></li>
<li><p>Static files (*.html, *.css, *.jpg, *.png, etc) should be set to 664.</p></li>
<li><p>Directories should be set to 2775 (set GID set).</p></li>
<li><p>All other files should be set to 664 unless there’s a good reason not to do so.</p></li>
</ul>
<p>Restarting server with <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">shutdown</span> <span class="pre">-r</span> <span class="pre">now</span></code> to test the above configurations</p>
</div>
<div class="section" id="ssl-certificate">
<h4>SSL Certificate<a class="headerlink" href="#ssl-certificate" title="Permalink to this headline">¶</a></h4>
<p>Help via:</p>
<ul class="simple">
<li><p><a class="reference external" href="#">https://help.ubuntu.com/lts/serverguide/certificates-and-security.html</a></p></li>
<li><p><a class="reference external" href="#">https://wiki.it.ox.ac.uk/itss/CertificateService</a></p></li>
</ul>
<p>Steps for request</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">.</span><span class="n">ssh</span><span class="o">/</span>
<span class="n">mkdir</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span>
<span class="n">cd</span> <span class="n">ssl</span><span class="o">-</span><span class="n">cert</span><span class="o">/</span>
<span class="n">vi</span> <span class="n">website</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
<p>Into which we used the following</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="n">req</span> <span class="p">]</span>
    <span class="n">prompt</span>                 <span class="o">=</span> <span class="n">no</span>
    <span class="n">default_bits</span>           <span class="o">=</span> <span class="mi">2048</span>
    <span class="n">default_md</span>             <span class="o">=</span> <span class="n">sha256</span>
    <span class="n">distinguished_name</span>     <span class="o">=</span> <span class="n">dn</span>
<span class="p">[</span> <span class="n">dn</span> <span class="p">]</span>
    <span class="n">C</span>                      <span class="o">=</span> <span class="n">GB</span>
    <span class="n">ST</span>                     <span class="o">=</span> <span class="n">Oxfordshire</span>
    <span class="n">L</span>                      <span class="o">=</span> <span class="n">Oxford</span>
    <span class="n">O</span>                      <span class="o">=</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Oxford</span>
    <span class="n">OU</span>                     <span class="o">=</span> <span class="n">Nuffield</span> <span class="n">Department</span> <span class="n">of</span> <span class="n">Surgical</span> <span class="n">Sciences</span>
    <span class="n">CN</span>                     <span class="o">=</span> <span class="n">cope</span><span class="o">.</span><span class="n">nds</span><span class="o">.</span><span class="n">ox</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span>
</pre></div>
</div>
<p>And then</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">req</span> <span class="o">-</span><span class="n">new</span> <span class="o">-</span><span class="n">keyout</span> <span class="n">private</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">out</span> <span class="n">cope</span><span class="o">.</span><span class="n">nds</span><span class="o">.</span><span class="n">csr</span> <span class="o">-</span><span class="n">config</span> <span class="o">./</span><span class="n">website</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">cfg</span> <span class="o">-</span><span class="n">batch</span> <span class="o">-</span><span class="n">verbose</span> <span class="o">-</span><span class="n">nodes</span>

<span class="n">Using</span> <span class="n">configuration</span> <span class="kn">from</span> <span class="nn">.</span><span class="o">/</span><span class="n">website</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">cfg</span>
<span class="n">Generating</span> <span class="n">a</span> <span class="mi">2048</span> <span class="n">bit</span> <span class="n">RSA</span> <span class="n">private</span> <span class="n">key</span>
<span class="o">.............................................+++</span>
<span class="o">..............................................+++</span>
<span class="n">writing</span> <span class="n">new</span> <span class="n">private</span> <span class="n">key</span> <span class="n">to</span> <span class="s1">&#39;private.pem&#39;</span>
<span class="o">-----</span>
</pre></div>
</div>
<p>Which resulted in a private.pem and cope.nds.csr files being created. The contents of the cope.nds.csr was then submitted to Trend via their port (see ITSS wiki link) and emailed to the ITS3 team for confirmation. One phone confirmation from ITS3 later, and an email arrives with the certificates zipped up, and a (supposedly the equivalent) .pem file of the
bundle. However, the .pem does not validate against the csr and private.pem (see <a class="reference external" href="#">https://www.sslshopper.com/certificate-key-matcher.html</a> or run the openssl validation checks below).</p>
<p>Copy the files to the server (scp), and put them into <code class="docutils literal notranslate"><span class="pre">~/.ssh/ssl-cert/</span></code>. Run unzip on the zip bundle, to get 3 .crt files returned. This now gives us:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">copeuser</span> <span class="n">copeuser</span> <span class="mi">1218</span> <span class="n">Dec</span> <span class="mi">14</span> <span class="mi">18</span><span class="p">:</span><span class="mi">20</span> <span class="n">AffirmTrust_Commercial</span><span class="o">.</span><span class="n">crt</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">copeuser</span> <span class="n">copeuser</span> <span class="mi">3624</span> <span class="n">Dec</span> <span class="mi">17</span> <span class="mi">16</span><span class="p">:</span><span class="mi">21</span> <span class="nb">all</span><span class="o">-</span><span class="n">certificate</span><span class="o">.</span><span class="n">zip</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">copeuser</span> <span class="n">copeuser</span> <span class="mi">1086</span> <span class="n">Dec</span> <span class="mi">14</span> <span class="mi">17</span><span class="p">:</span><span class="mi">48</span> <span class="n">cope</span><span class="o">.</span><span class="n">nds</span><span class="o">.</span><span class="n">csr</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">copeuser</span> <span class="n">copeuser</span> <span class="mi">1642</span> <span class="n">Dec</span> <span class="mi">14</span> <span class="mi">18</span><span class="p">:</span><span class="mi">20</span> <span class="n">cope</span><span class="o">.</span><span class="n">nds</span><span class="o">.</span><span class="n">ox</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">uk</span><span class="o">.</span><span class="n">crt</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">copeuser</span> <span class="n">copeuser</span> <span class="mi">1704</span> <span class="n">Dec</span> <span class="mi">14</span> <span class="mi">17</span><span class="p">:</span><span class="mi">48</span> <span class="n">private</span><span class="o">.</span><span class="n">pem</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">copeuser</span> <span class="n">copeuser</span> <span class="mi">2813</span> <span class="n">Dec</span> <span class="mi">17</span> <span class="mi">16</span><span class="p">:</span><span class="mi">21</span> <span class="n">s2cabundle</span><span class="o">.</span><span class="n">pem</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">copeuser</span> <span class="n">copeuser</span> <span class="mi">1630</span> <span class="n">Dec</span> <span class="mi">14</span> <span class="mi">18</span><span class="p">:</span><span class="mi">20</span> <span class="n">Trend_Micro_S2_CA</span><span class="o">.</span><span class="n">crt</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">copeuser</span> <span class="n">copeuser</span>  <span class="mi">465</span> <span class="n">Dec</span> <span class="mi">14</span> <span class="mi">17</span><span class="p">:</span><span class="mi">45</span> <span class="n">website</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
<p>Long story short, because we can’t validate the s2cabundle.pem file, we need to create our own .crt (or .pem, same thing) file by concatenating the three supplied certificates in the correct order, thus we do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cat cope.nds.ox.ac.uk.crt AffirmTrust_Commercial.crt Trend_Micro_S2_CA.crt &gt; cope.nds.crt

# Validation can now be done to confirm these all match!
copeuser@cope:~/.ssh/ssl-cert$ openssl rsa -noout -modulus -in private.pem | openssl md5
(stdin)= cf0888a35d5070123c032249b4010244
copeuser@cope:~/.ssh/ssl-cert$ openssl req -noout -modulus -in cope.nds.csr | openssl md5
(stdin)= cf0888a35d5070123c032249b4010244
copeuser@cope:~/.ssh/ssl-cert$ openssl x509 -noout -modulus -in cope.nds.ox.ac.uk.crt  | openssl md5
(stdin)= cf0888a35d5070123c032249b4010244
</pre></div>
</div>
<p>Now we’ll put a copy of this combined certificate chain, and our private key, in a folder accessible by the NGINX process, as that is acting as the SSL proxy server (see the configuration in <code class="docutils literal notranslate"><span class="pre">cope-repo/</span> <span class="pre">deploy/production/etc/nginx/sites-available/cope.conf</span></code> for how Nginx will use these)::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ngix</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span>    <span class="c1"># Yes, there is a typo in nginx</span>
<span class="n">cp</span> <span class="n">private</span><span class="o">.</span><span class="n">pem</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ngix</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span>
<span class="n">cp</span> <span class="n">cope</span><span class="o">.</span><span class="n">nds</span><span class="o">.</span><span class="n">crt</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ngix</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span>
</pre></div>
</div>
<p>With those in place, and using the config file above, you can got to <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">supervisorctl</span></code> and then <code class="docutils literal notranslate"><span class="pre">restart</span> <span class="pre">all</span></code>, and lo and behold, we have service on port 443.</p>
<p>It’s worth noting that <code class="docutils literal notranslate"><span class="pre">SECURE_PROXY_SSL_HEADER</span> <span class="pre">=</span> <span class="pre">('HTTP_X_FORWARDED_PROTOCOL',</span> <span class="pre">'https')</span></code> needed to be added to the production.py settings file so that Django can detect if https is being used, otherwise when you set <code class="docutils literal notranslate"><span class="pre">DJANGO_SECURE_SSL_REDIRECT=True</span></code> in the <code class="docutils literal notranslate"><span class="pre">local.env</span></code> file, you will get a redirect loop in the browser.</p>
<p>The string “HTTP_X_FORWARDED_PROTOCOL” is derived from <code class="docutils literal notranslate"><span class="pre">proxy_set_header</span> <span class="pre">X-Forwarded-Protocol</span> <span class="pre">$scheme;</span></code> in the nginx conf combined with the note from <a class="reference external" href="#">https://docs.djangoproject.com/en/dev/ref/settings/#secure-proxy-ssl-header</a> saying:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Note that the header needs to be in the format as used by request.META – all caps 
and likely starting with HTTP_. (Remember, Django automatically adds &#39;HTTP_&#39; to the 
start of x-header names before making the header available in request.META.)
</pre></div>
</div>
<p>Port 443 has been confirmed as open on the MSD firewall for cope.nds.ox.ac.uk</p>
</div>
<div class="section" id="migrating-to-python-3-and-postgres">
<h4>Migrating to Python 3 and Postgres<a class="headerlink" href="#migrating-to-python-3-and-postgres" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p>Perform the usual system maintenance (apt-get update, upgrade, autoclean, etc)</p></li>
<li><p>Using installed python 3.4.3</p>
<ul class="simple">
<li><p>Needs extra: <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">python3.4-dev</span> <span class="pre">libpq-dev</span></code> for psycopg2 to install</p></li>
</ul>
</li>
<li><p>Installed postgres following instructions at <a class="reference external" href="#">https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-14-04</a>.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">postgresql</span> <span class="pre">postgresql-contrib</span></code></p></li>
<li><p>Results in Postgres 9.3 being installed.</p></li>
<li><p>Created user <code class="docutils literal notranslate"><span class="pre">copedb</span></code> and database <code class="docutils literal notranslate"><span class="pre">copedb</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>postgres@cope:~$ createuser --interactive
Enter name of role to add: copedb
Shall the new role be a superuser? (y/n) n
Shall the new role be allowed to create databases? (y/n) n
Shall the new role be allowed to create more new roles? (y/n) n
postgres@cope:~$ createdb copedb
</pre></div>
</div>
</li>
<li><p>Set password on user. <code class="docutils literal notranslate"><span class="pre">postgres=#</span> <span class="pre">\password</span> <span class="pre">copedb</span></code></p></li>
</ul>
</li>
</ul>
<p>Follow site setup again, but pointing at <code class="docutils literal notranslate"><span class="pre">/usr/bin/python3</span></code> for virtualenv, and changing the files linked below to use the new <code class="docutils literal notranslate"><span class="pre">/sites/py3_cope</span> <span class="pre">path</span></code>::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkproject</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span> <span class="n">py3_cope</span>
<span class="c1"># NB: cwd is now /sites/py3_cope</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">AllyBradley</span><span class="o">/</span><span class="n">COPE</span><span class="o">.</span><span class="n">git</span> <span class="n">cope_repo</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">var</span><span class="o">/</span><span class="n">log</span> <span class="n">var</span><span class="o">/</span><span class="n">run</span> <span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span> <span class="n">htdocs</span><span class="o">/</span><span class="n">media</span> <span class="n">etc</span><span class="o">/</span><span class="n">gunicorn</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/.</span><span class="n">virtualenvs</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">/</span><span class="n">lib</span> <span class="o">./</span><span class="n">lib</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/.</span><span class="n">virtualenvs</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">/</span><span class="nb">bin</span> <span class="o">./</span><span class="nb">bin</span>

<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">/</span><span class="n">cope_repo</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">cope</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">rm</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span><span class="o">/</span><span class="n">cope</span><span class="o">.</span><span class="n">conf</span> 

<span class="n">sudo</span> <span class="n">rm</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span> 
<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">/</span><span class="n">cope_repo</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span>

<span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">/</span><span class="n">cope_repo</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">django</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">py3_django</span><span class="o">.</span><span class="n">conf</span>
<span class="c1"># sudo rm /etc/supervisor/conf.d/django.conf  &lt;-- See Supervisor config steps below</span>

<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">/</span><span class="n">cope_repo</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn_start</span><span class="o">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn_start</span><span class="o">.</span><span class="n">sh</span>
<span class="n">chmod</span> <span class="mi">775</span> <span class="o">/</span><span class="n">sites</span><span class="o">/</span><span class="n">py3_cope</span><span class="o">/</span><span class="n">cope_repo</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">production</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gunicorn_start</span><span class="o">.</span><span class="n">sh</span>

<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">www</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="n">worker</span> <span class="o">*</span>

<span class="n">cd</span> <span class="n">cope_repo</span>
<span class="n">chmod</span> <span class="mi">775</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">/</span><span class="n">production</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>Continue the site setup (<code class="docutils literal notranslate"><span class="pre">python</span></code> will default to the environment version of 3.4.3).</p>
<ul class="simple">
<li><p>Use the previous local.env file (<code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">../../cope/cope_repo/local.env</span> <span class="pre">local.env</span></code> - NB: edit the static root path!), as we need to setup first to use the existing sqlite db file, and then port it to the new postgres engine.</p></li>
<li><p>Don’t forget a location.env file too (<code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">../../cope/cope_repo/location.env</span> <span class="pre">location.env</span></code>)</p></li>
<li><p>And we need the existing data: <code class="docutils literal notranslate"><span class="pre">cp</span> <span class="pre">../../cope/cope_repo/db.sqlite3</span> <span class="pre">./db.sqlite3</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">check</span></code></p></li>
<li><p>Because of breaking DB changes in 0.6.0, the previous ‘followups’ migrations need to be cleared from the database before we migrate, otherwise we won’t have the tables in.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">dbshell</span></code> and then <code class="docutils literal notranslate"><span class="pre">DELETE</span> <span class="pre">FROM</span> <span class="pre">django_migrations</span> <span class="pre">WHERE</span> <span class="pre">app=&quot;followups&quot;;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">collectstatic</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">compilemessages</span></code></p></li>
</ul>
<p>Now is a good time to reboot the server, then we can go and see about gunicorn config/starting.</p>
</div>
<div class="section" id="supervisor-config">
<h4>Supervisor Config<a class="headerlink" href="#supervisor-config" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">supervisorctl</span></code> to get into the interactive shell. Then:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">reread</span></code> should show a new app available (py3-cope-django)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stop</span> <span class="pre">cope-django</span></code> to turn off the old app</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">remove</span> <span class="pre">cope-django</span></code> to stop it coming back on reboot</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">add</span> <span class="pre">py3-cope-django</span></code> to make the new config active for use</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">start</span> <span class="pre">py3-cope-django</span></code>… and we should be good to go</p></li>
<li><p>When we’re happy everything is running we can do some cleanup:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">rm</span> <span class="pre">/etc/supervisor/conf.d/django.conf</span></code></p></li>
</ul>
</div>
<div class="section" id="debugging-supervisor">
<h4>Debugging Supervisor<a class="headerlink" href="#debugging-supervisor" title="Permalink to this headline">¶</a></h4>
<p>On the likely outcome that something doesn’t work, remember the following:</p>
<ul class="simple">
<li><p>Supervisor log output goes to <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/var/log/supervisor/</span></code>, and this require root priviledges</p></li>
<li><p>Nginx default log output goes to <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/var/log/nginx/</span></code>, and is also root only access</p></li>
<li><p>Gunicorn root log folder should be empty, but is at <code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/var/log/gunicorn/</span></code></p></li>
</ul>
</div>
<div class="section" id="reset-backup">
<h4>Reset backup:<a class="headerlink" href="#reset-backup" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Make backup dir</p></li>
<li><p>Link the dbbackup.sh script to the local bin folder</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/sites/py3_cope/cope_repo/deploy/production/bin/dbbackup.sh</span> <span class="pre">/sites/py3_cope/bin/dbbackup.sh</span></code></p></li>
<li><p>Update Cron with the new path</p></li>
</ul>
</div>
<div class="section" id="migrating-from-lts-14-04-to-lts-16-04-1">
<h4>Migrating from LTS 14.04 to LTS 16.04.1<a class="headerlink" href="#migrating-from-lts-14-04-to-lts-16-04-1" title="Permalink to this headline">¶</a></h4>
<p>…did not go smoothly :-/</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">autoremove</span></code> to clear enough space on <code class="docutils literal notranslate"><span class="pre">/boot</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">do-release-upgrade</span></code></p></li>
<li><p>Will need to update <code class="docutils literal notranslate"><span class="pre">\etc\sudoers</span></code> via the command <code class="docutils literal notranslate"><span class="pre">visudo</span></code> which has to be executed as root</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">/etc/nginx/nginx.conf</span></code></p></li>
<li><p>Investigate the Postgres updates</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">supervisor.service</span></code> to re-enable supervisor to start on bootup</p></li>
<li><p>Reboot the server manually</p></li>
<li><p>… now we diagnose why the supervisor cope script won’t start up; outwardly because the virtualenv is not working.</p></li>
<li><p>Recreate the virtualenv, because the python links are broken since there has been a change from python3.4 to python3.5</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Configuring postgresql-common ├─────────────────────────────────────────┐  
 │                                                                                                                   │  
 │ Obsolete major version 9.3                                                                                        │  
 │                                                                                                                   │  
 │ The PostgreSQL version 9.3 is obsolete, but the server or client packages are still installed. Please install     │  
 │ the latest packages (postgresql-9.5 and postgresql-client-9.5) and upgrade the existing  clusters with            │  
 │ pg_upgradecluster (see manpage).                                                                                  │  
 │                                                                                                                   │  
 │ Please be aware that the installation of postgresql-9.5 will automatically create a default cluster 9.5/main. If  │  
 │ you want to upgrade the 9.3/main cluster, you need to remove the already existing 9.5 cluster (pg_dropcluster     │  
 │ --stop 9.5 main, see manpage for details).                                                                        │  
 │                                                                                                                   │  
 │ The old server and client packages are no longer supported. After the existing clusters are upgraded, the         │  
 │ postgresql-9.3 and postgresql-client-9.3 packages should be removed.                                              │  
 │                                                                                                                   │  
 │ Please see /usr/share/doc/postgresql-common/README.Debian.gz for details.         
</pre></div>
</div>
</div>
<div class="section" id="migrating-from-lts-16-04-1-to-lts-18-01">
<h4>Migrating from LTS 16.04.1 to LTS 18.01<a class="headerlink" href="#migrating-from-lts-16-04-1-to-lts-18-01" title="Permalink to this headline">¶</a></h4>
<p>Went much more smoothly, and followed a similar process.</p>
</div>
</div>
<div class="section" id="footnotes-for-production">
<h3>Footnotes for Production<a class="headerlink" href="#footnotes-for-production" title="Permalink to this headline">¶</a></h3>
<p>Useful commands:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cut</span> <span class="pre">-d:</span> <span class="pre">-f1</span> <span class="pre">/etc/passwd</span></code> – lists all users</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">--purge</span> <span class="pre">remove</span> <span class="pre">{{package-name}}</span></code> – remove an installed package and config files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">apt</span> <span class="pre">--installed</span> <span class="pre">list</span></code> – list all installed packages</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">netstat</span> <span class="pre">-peanut</span></code>  – list all ports in use on system</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">-auxf</span></code> – list all processes in a tree showing originating process</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">--</span> <span class="pre">path/file.py</span></code> – reset a file back to the last git version</p></li>
</ul>
<p>Reference urls:</p>
<ul class="simple">
<li><p>Gunicorn - <a class="reference external" href="#">http://docs.gunicorn.org/en/latest/index.html</a></p></li>
<li><p>Supervisor - <a class="reference external" href="#">http://supervisord.org/index.html</a></p></li>
<li><p>Django Security - <a class="reference external" href="#">https://docs.djangoproject.com/en/1.8/topics/security/</a></p></li>
<li><p>NGinx Admin Guide - <a class="reference external" href="#">https://www.nginx.com/resources/admin-guide/</a></p></li>
<li><p>NGinx Getting Started Wiki - <a class="reference external" href="#">https://www.nginx.com/resources/wiki/start/</a></p></li>
<li><p>NGinx Beginners Guide - <a class="reference external" href="#">http://nginx.org/en/docs/beginners_guide.html</a></p></li>
<li><p>Ubuntu Apt-Get Guide - <a class="reference external" href="#">https://help.ubuntu.com/community/AptGet/Howto#Search_commands</a></p></li>
<li><p>Django Secure - <a class="reference external" href="#">http://django-secure.readthedocs.org/en/latest/</a></p></li>
</ul>
</div>
</div>
<div class="section" id="test-staging-dev-nds">
<h2>Test/Staging (dev.nds)<a class="headerlink" href="#test-staging-dev-nds" title="Permalink to this headline">¶</a></h2>
<p>Test server deployment is to the dev.nds server, accessible under <a class="reference external" href="#">https://dev.nds.ox.ac.uk/cope/</a>. This is an Ubuntu 16.04 Server with similar setup to the Production environment. This location was moved here from external (personal) hosting in Nov 2017, having been online in its previous setup since Aug 2015.</p>
<p>At time of writing, this system is offline for unknown reasons.</p>
<p>Deployment Outline</p>
<ul>
<li><p>Create project <code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">mkproject</span> <span class="pre">-p</span> <span class="pre">/usr/bin/python3</span> <span class="pre">cope</span></code></p>
<ul class="simple">
<li><p>This will activate the new virtualenv, and drop you into <code class="docutils literal notranslate"><span class="pre">/sites/cope</span></code></p></li>
</ul>
</li>
<li><p>Create project user <code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">sudo</span> <span class="pre">useradd</span> <span class="pre">--system</span> <span class="pre">--gid</span> <span class="pre">worker</span> <span class="pre">--shell</span> <span class="pre">/bin/bash</span> <span class="pre">--home</span> <span class="pre">/sites/cope</span> <span class="pre">cope-app-user</span></code></p></li>
<li><p>Clone repository, select branch</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">git</span> <span class="pre">clone</span> <span class="pre">git&#64;github.com:ouh-churchill/cope.git</span> <span class="pre">cope_repo</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">cd</span> <span class="pre">cope_repo/</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">testing</span></code></p></li>
</ul>
</li>
<li><p>Create subfolders, link virtualenv folders</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">cd</span> <span class="pre">..</span></code> &lt;– return to <code class="docutils literal notranslate"><span class="pre">/sites/cope</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/sites/.virtualenvs/cope/lib</span> <span class="pre">./lib</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/sites/.virtualenvs/cope/bin</span> <span class="pre">./bin</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">mkdir</span> <span class="pre">-p</span> <span class="pre">var/log</span> <span class="pre">var/run</span> <span class="pre">etc/nginx/sites-available</span> <span class="pre">htdocs/media</span> <span class="pre">etc/gunicorn</span></code></p></li>
</ul>
</li>
<li><p>Install requirements</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">cd</span> <span class="pre">cope_repo/</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements/staging.txt</span></code></p></li>
</ul>
</li>
<li><p>Modify local <code class="docutils literal notranslate"><span class="pre">.env</span></code> settings</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">cp</span> <span class="pre">config/settings/.env.template</span> <span class="pre">config/settings/.env</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">vi</span> <span class="pre">config/settings/.env</span></code> – Put in local setting values</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">check</span></code></p></li>
</ul>
</li>
<li><p>Create database (port from old location)</p>
<ul class="simple">
<li><p>Check it is current with <code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">migrate</span></code>, there should be no missing migrations.</p></li>
</ul>
</li>
<li><p>Copy the static content into place <code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">collectstatic</span></code></p></li>
<li><p>Copy deployment files into system folders (nginx, supervisor, etc)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/sites/cope/cope_repo/deploy/staging/bin/gunicorn_start.sh</span> <span class="pre">/sites/cope/bin/gunicorn_start.sh</span></code> – copy the gunicorn script into the project’s bin folder, where the gunicorn config expects to find it</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">cd</span> <span class="pre">/etc/supervisor/conf.d/</span></code> – goto the supervisorctl config folder</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">sudo</span> <span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/sites/cope/cope_repo/deploy/staging/etc/supervisor/conf.d/cope-django.conf</span> <span class="pre">./cope-django.conf</span></code> – copy the config from the repo into the system folder</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">cd</span> <span class="pre">/sites</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">sudo</span> <span class="pre">chown</span> <span class="pre">-R</span> <span class="pre">carl:worker</span> <span class="pre">cope/</span></code> to make all the files now part of the <code class="docutils literal notranslate"><span class="pre">worker</span></code> group and thus executable by the <code class="docutils literal notranslate"><span class="pre">cope-app-worker</span></code> user.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">sudo</span> <span class="pre">supervisorctl</span></code> to begin loading of the new config, and to start the process</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reread</span></code> to find the config. <code class="docutils literal notranslate"><span class="pre">add</span> <span class="pre">cope</span></code> to make supervisor recognise it. <code class="docutils literal notranslate"><span class="pre">start</span> <span class="pre">cope</span></code> to kick the process off.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">cd</span> <span class="pre">/etc/nginx/sites-available/</span></code> to get to the nginx config location</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">sudo</span> <span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/sites/cope/cope_repo/deploy/staging/etc/nginx/sites-available/cope.conf</span> <span class="pre">cope.conf</span></code> to bring in the cope proxy site config</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">cd</span> <span class="pre">../sites-enabled/</span></code> to move into the enabled sites folder</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">sudo</span> <span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">../sites-available/cope.conf</span> <span class="pre">cope.conf</span></code> to make nginx recognise this as an active site</p></li>
</ul>
</li>
<li><p>Link into the main Nginx config via sites-available</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">sudo</span> <span class="pre">vi</span> <span class="pre">default</span></code> to edit the main nginx server config, and to add in our new location</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>location /cope {
    proxy_set_header X-Forwarded-Protocol $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $http_host;
    proxy_set_header X-Scheme $scheme;
    proxy_set_header X-Forwarded-For $remote_addr;

    proxy_pass http://localhost:9002/;
}
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">nginx</span></code> to reload the config, and start the site</p></li>
</ul>
</li>
</ul>
<div class="section" id="todo">
<h3>TODO<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h3>
<p>Create a link to the auto-deploy script and add it to the crontab e.g. (from webfaction docs):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ln -s cope_repo/deploy/webfaction/deploy-cm13.sh ./update_by_cron.sh
chmod 755 COPE/deploy/webfaction/deploy-cm13.sh
crontab -e    # To edit the cron record, and to insert...
*/2 * * * * $HOME/webapps/wp4_django/update_by_cron.sh &gt;&gt; $HOME/webapps/wp4_django/cron-wp4_django.log 2&gt;&amp;1
</pre></div>
</div>
</div>
</div>
<div class="section" id="development-localhost">
<h2>Development (localhost)<a class="headerlink" href="#development-localhost" title="Permalink to this headline">¶</a></h2>
<p>Local development deployment notes on this can be found in <a class="reference internal" href="development.html"><span class="doc">Development</span></a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="development.html" class="btn btn-neutral float-right" title="Development" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="user_manual.html" class="btn btn-neutral float-left" title="COPE DB User Manual" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-2019, Carl Marshall

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>